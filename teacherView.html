<!DOCTYPE html>
<head>
    <link rel="stylesheet" type="text/css" href="/styles/imports.css">
    <link rel="stylesheet" type="text/css" href="/styles/layout.css">
    <link rel="stylesheet" type="text/css" href="/styles/nav.css">

    <link rel="stylesheet" type="text/css" href="/styles/teacherView.css">

    <title>Teacher</title>
    <link rel="icon" href="/assets/strix_logo.png">
</head>
<html>
<body>
    <!-- Header -->
    <header>
        <div class="logo">
            <a id="unilogo" href="about.html"><img src="/assets/strix_logo.png" /></a>
        </div>
        <div class="pagetitle" id="pagename">

        </div>
        <div class="thenavigation">
            <a id="navcontroller" class="fa fa-bars hamburger" onclick="swapnav('open')"></a>
        </div>
    </header>

    <!-- Navigation -->
    <nav id="navigation">
        <div class="cover" onclick="swapnav('close')"></div>
        <div class="NavContainer">
            <video id="navigationbgvideo" class="bgvid" src="/assets/Navigation.mp4" muted autoplay loop></video>
            <div class="close">
                <a id="navcontroller" class="fa fa-times" onclick="swapnav('close')"></a>
            </div>
            <div class="NavSubContainer">
                <a onclick="gopage('about')" id="aboutbtn">About</a>
                <a onclick="gopage('maps')" id="campmap">University Information</a>
                <a onclick="gopage('news')" id="news">Strixhaven Star</a>
                <a onclick="gopage('libary')" id="admin">Library</a>
                <a onclick="gopage('activities')" id="extcurr">Extracurriculars</a>
                <a onclick="gopage('admin')" id="admin">Administration</a>
                <a onclick="gopage('login')" id="login">Login</a>
                <div class="logState"></div>
            </div>
            <footer>
                <div>
                    Created by <a href="https://morganwilsonslider.wordpress.com" target="_blank">Morgan Wilson-Slider</a>
                </div>
            </footer>
        </div>
    </nav>

    <!-- BG -->
    <div id="bg1"></div>
    <div id="particleGenerator"></div>

    <!-- Main -->
    <main>
        <div class="leftnav Vscrollbar">
            <div class="block">
                <a href="about.html">
                    <img id="collegeLogo" src="assets/strix_logo.png" />
                </a>
            </div>
            <div id="subnavchoices" class="choices">
                <div class="choice" id="ppp">
                    <button class="dropdown-btn">
                        <p>Players</p>
                        <i class="fa fa-caret-down"></i>
                    </button>
                    <div class="dropdown-container">

                        <button class="subbtn">
                            <p>Morgan</p>
                            <i class="fa fa-caret-down"></i>
                        </button>
                        <div class="sub dropdown-container">
                            <p class="subNavChoice">Profile</p>
                            <p class="subNavChoice">Details</p>
                            <p class="subNavChoice">Courses</p>
                            <p class="subNavChoice">Exams</p>
                            <p class="subNavChoice">Job and Extras</p>
                            <p class="subNavChoice">Relationships</p>
                        </div>

                        <button class="subbtn">
                            <p>Sami</p>
                            <i class="fa fa-caret-down"></i>
                        </button>
                        <div class="sub dropdown-container">
                            <p class="subNavChoice">Profile</p>
                            <p class="subNavChoice">Details</p>
                            <p class="subNavChoice">Courses</p>
                            <p class="subNavChoice">Exams</p>
                            <p class="subNavChoice">Job and Extras</p>
                            <p class="subNavChoice">Relationships</p>
                        </div>

                        <button class="subbtn">
                            <p>Timo</p>
                            <i class="fa fa-caret-down"></i>
                        </button>
                        <div class="sub dropdown-container">
                            <p class="subNavChoice">Profile</p>
                            <p class="subNavChoice">Details</p>
                            <p class="subNavChoice">Courses</p>
                            <p class="subNavChoice">Exams</p>
                            <p class="subNavChoice">Job and Extras</p>
                            <p class="subNavChoice">Relationships</p>
                        </div>

                        <button class="subbtn">
                            <p>Martin</p>
                            <i class="fa fa-caret-down"></i>
                        </button>
                        <div class="sub dropdown-container">
                            <p class="subNavChoice">Profile</p>
                            <p class="subNavChoice">Details</p>
                            <p class="subNavChoice">Courses</p>
                            <p class="subNavChoice">Exams</p>
                            <p class="subNavChoice">Job and Extras</p>
                            <p class="subNavChoice">Relationships</p>
                        </div>

                        <button class="subbtn">
                            <p>Will</p>
                            <i class="fa fa-caret-down"></i>
                        </button>
                        <div class="sub dropdown-container">
                            <p class="subNavChoice">Profile</p>
                            <p class="subNavChoice">Details</p>
                            <p class="subNavChoice">Courses</p>
                            <p class="subNavChoice">Exams</p>
                            <p class="subNavChoice">Job and Extras</p>
                            <p class="subNavChoice">Relationships</p>
                        </div>

                        <button class="subbtn">
                            <p>Lulu</p>
                            <i class="fa fa-caret-down"></i>
                        </button>
                        <div class="sub dropdown-container">
                            <p class="subNavChoice">Profile</p>
                            <p class="subNavChoice">Details</p>
                            <p class="subNavChoice">Courses</p>
                            <p class="subNavChoice">Exams</p>
                            <p class="subNavChoice">Job and Extras</p>
                            <p class="subNavChoice">Relationships</p>
                        </div>

                    </div>
                </div>
                <div class="choice">
                    <p>Strixhaven Star</p>
                </div>
                <div class="choice">
                    <p>NPCs</p>
                </div>
                <div class="choice">
                    <p>Extra Notes</p>
                </div>
                <div class="choice">
                    <p>Coming Soon</p>
                </div>
                <div class=choice>
                    <p>Account</p>
                </div>
                <div class="choice">
                    <p>Logout</p>
                </div>
            </div>
        </div>
        <div id="pages" class="mainpage">
            <div class="page" id="players" hidden>
                <h2>Players</h2>
                <div class="mainbody">
                    <div class="view" id="profile">
                        <div class="controls">
                            <button id="save" class="control fa fa-floppy-o"></button>
                        </div>
                        <div class="top">
                            <div class="card">
                                <img id="profilepicture" />
                            </div>
                                <form id="profileform1">
                                    <input id="pid" hidden />
                                    <input id="player" hidden />
                                    <label>Name: <input id="name" placeholder="Name" disabled /></label>
                                    <label>Age: <input id="age" placeholder="Age" disabled /></label>
                                    <label>Gender: <input id="gender" placeholder="Gender" disabled /></label>
                                    <label>Race: <input id="race" placeholder="Race" disabled /></label>
                                    <label>Subrace: <input id="subrace" placeholder="Subrace" disabled /></label>
                                    <label>Class: <input id="class" placeholder="Class" disabled /></label>
                                    <label>Subclass: <input id="subclass" placeholder="Subclass" disabled /></label>
                                    <label>Level: <input id="level" placeholder="Level" disabled /></label>
                                </form>
                                <form id="profileform2">
                                    <label>Alignment: <input id="alignment" placeholder="Alignment" disabled /></label>
                                    <label>Height: <input id="height" placeholder="Height" disabled /></label>
                                    <label>Weight: <input id="weight" placeholder="Weight" disabled /></label>
                                    <label>Hair Colour: <input id="haircolour" placeholder="Hair Colour" disabled /></label>
                                    <label>Eye Colour: <input id="eyecolour" placeholder="Eye Colour" disabled /></label>
                                    <label>Background: <input id="background" placeholder="Background" disabled /></label>
                                    <label>Year: <input id="year" placeholder="Year" disabled /></label>
                                    <label>
                                        College:
                                        <select id="college">
                                            <option value="0">-- Please Select College Choice --</option>
                                        </select>
                                    </label>
                                </form>
                        </div>
                        <div class="bottom">
                            <div class="personality scrollbar">
                                <div class="personal">
                                    <p>Personality Traits:</p>
                                    <textarea id="personalitytraits" class="scrollbar" placeholder="Personality Traits" readonly></textarea>
                                </div>
                                <div class="personal">
                                    <p>Ideals:</p>
                                    <textarea id="ideals" class="scrollbar" placeholder="Ideals" readonly></textarea>
                                </div>
                                <div class="personal">
                                    <p>Bonds:</p>
                                    <textarea id="bonds" class="scrollbar" placeholder="Bonds" readonly></textarea>
                                </div>
                                <div class="personal">
                                    <p>Flaws:</p>
                                    <textarea id="flaws" class="scrollbar" placeholder="Flaws" readonly></textarea>
                                </div>
                                <div class="personal">
                                    <p>Goals:</p>
                                    <textarea id="goals" class="scrollbar" placeholder="Your life time desire" readonly></textarea>
                                </div>
                            </div>
                            <div class="right">
                                <div class="formfield">
                                    <label>Background Features:</label>
                                    <textarea id="backgroundfeatures" class="scrollbar" placeholder="Background Features" readonly></textarea>
                                </div>
                                <div class="formfield">
                                    <label>Additional Character Appearance:</label>
                                    <textarea id="appearance" class="scrollbar" placeholder="Additional Character Appearance" readonly></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="view" id="details" hidden>
                        <div class="splitbody">
                            <div class="split">
                                <p>Backstory:</p>
                                <textarea id="backstory" class="scrollbar" placeholder="Backstory" readonly></textarea>
                            </div>
                            <div class="split">
                                <p>Extras:</p>
                                <textarea id="extranotes" class="scrollbar" placeholder="Extra notes" readonly></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="view" id="courses" hidden>
                        <div class="top">
                            <div class="year" id="Cyr1">
                                <div class="controls">
                                    <button id="edit" class="control fa fa-pencil-square-o"></button>
                                    <button id="save" class="control fa fa-floppy-o"></button>
                                </div>
                                <h3>Yr 1</h3>
                                <div class="coursechoices">
                                    <div id="Y1S1" class="coursechoice">
                                        <select>
                                            <option>-- Select Course --</option>
                                        </select>
                                        <div class="classTeacher">
                                            <p></p>
                                        </div>
                                    </div>
                                    <div id="Y1S2" class="coursechoice">
                                        <select>
                                            <option>-- Select Course --</option>
                                        </select>
                                        <div class="classTeacher">
                                            <p></p>
                                        </div>
                                    </div>
                                    <div id="Y1S3" class="coursechoice">
                                        <select>
                                            <option>-- Select Course --</option>
                                        </select>
                                        <div class="classTeacher">
                                            <p></p>
                                        </div>
                                    </div>
                                    <div id="Y1S4" class="coursechoice">
                                        <select>
                                            <option>-- Select Course --</option>
                                        </select>
                                        <div class="classTeacher">
                                            <p></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="year" id="Cyr2">
                                <div class="controls">
                                    <button id="edit" class="control fa fa-pencil-square-o"></button>
                                    <button id="save" class="control fa fa-floppy-o"></button>
                                </div>
                                <h3>Yr 2</h3>
                                <div class="coursechoices">
                                    <div id="Y2S1" class="coursechoice">
                                        <select>
                                            <option>-- Select Course --</option>
                                        </select>
                                        <div class="classTeacher">
                                            <p></p>
                                        </div>
                                    </div>
                                    <div id="Y2S2" class="coursechoice">
                                        <select>
                                            <option>-- Select Course --</option>
                                        </select>
                                        <div class="classTeacher">
                                            <p></p>
                                        </div>
                                    </div>
                                    <div id="Y2S3" class="coursechoice">
                                        <select>
                                            <option>-- Select Course --</option>
                                        </select>
                                        <div class="classTeacher">
                                            <p></p>
                                        </div>
                                    </div>
                                    <div id="Y2S4" class="coursechoice">
                                        <select>
                                            <option>-- Select Course --</option>
                                        </select>
                                        <div class="classTeacher">
                                            <p></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bottom">
                            <div class="year" id="Cyr3">
                                <div class="controls">
                                    <button id="edit" class="control fa fa-pencil-square-o"></button>
                                    <button id="save" class="control fa fa-floppy-o"></button>
                                </div>
                                <h3>Yr 3</h3>
                                <div class="coursechoices">
                                    <div id="Y3S1" class="coursechoice">
                                        <select>
                                            <option>-- Select Course --</option>
                                        </select>
                                        <div class="classTeacher">
                                            <p></p>
                                        </div>
                                    </div>
                                    <div id="Y3S2" class="coursechoice">
                                        <select>
                                            <option>-- Select Course --</option>
                                        </select>
                                        <div class="classTeacher">
                                            <p></p>
                                        </div>
                                    </div>
                                    <div id="Y3S3" class="coursechoice">
                                        <select>
                                            <option>-- Select Course --</option>
                                        </select>
                                        <div class="classTeacher">
                                            <p></p>
                                        </div>
                                    </div>
                                    <div id="Y3S4" class="coursechoice">
                                        <select>
                                            <option>-- Select Course --</option>
                                        </select>
                                        <div class="classTeacher">
                                            <p></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="year" id="Cyr4">
                                <div class="controls">
                                    <button id="edit" class="control fa fa-pencil-square-o"></button>
                                    <button id="save" class="control fa fa-floppy-o"></button>
                                </div>
                                <h3>Yr 4</h3>
                                <div class="coursechoices">
                                    <div id="Y4S1" class="coursechoice">
                                        <select>
                                            <option>-- Select Course --</option>
                                        </select>
                                        <div class="classTeacher">
                                            <p></p>
                                        </div>
                                    </div>
                                    <div id="Y4S2" class="coursechoice">
                                        <select>
                                            <option>-- Select Course --</option>
                                        </select>
                                        <div class="classTeacher">
                                            <p></p>
                                        </div>
                                    </div>
                                    <div id="Y4S3" class="coursechoice">
                                        <select>
                                            <option>-- Select Course --</option>
                                        </select>
                                        <div class="classTeacher">
                                            <p></p>
                                        </div>
                                    </div>
                                    <div id="Y4S4" class="coursechoice">
                                        <select>
                                            <option>-- Select Course --</option>
                                        </select>
                                        <div class="classTeacher">
                                            <p></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="view" id="exams" hidden>
                        <div class="controls">
                            <button id="save" class="control fa fa-floppy-o"></button>
                        </div>
                        <div class="top">
                            <div class="year">
                                <h3>Yr 1</h3>
                                <div class="exams">

                                </div>
                            </div>
                            <div class="year">
                                <h3>Yr 2</h3>
                                <div class="exams">

                                </div>
                            </div>
                        </div>
                        <div class="bottom">
                            <div class="year">
                                <h3>Yr 3</h3>
                                <div class="exams">

                                </div>
                            </div>
                            <div class="year">
                                <h3>Yr 4</h3>
                                <div class="exams">

                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="view" id="jobandextras" hidden>
                        <div id="jobs">
                        </div>
                        <h2>Extracurricular</h2>
                        <div id="clubs">
                        </div>
                    </div>

                    <div class="view" id="relationships" hidden>
                        <div class="controls">
                            <button id="add" class="control fa fa-plus"></button>
                            <button id="edit" class="control fa fa-pencil-square-o"></button>
                            <button id="save" class="control fa fa-floppy-o"></button>
                        </div>
                        <div class="cubeWrapper">
                            <div id="cubes">
                            </div>
                        </div>
                        <div class="model" id="addModel" hidden>
                            <h1>Add new relationship</h1>
                            <select id="addRelationNPCs">
                                <option value="0">-- Please select a Student --</option>
                            </select>
                            <button id="confirmRelation">Add relationship</button>
                            <button id="cancleRelation">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="page ss" id="strixhaven star" hidden>
                <div class="controls">
                    <button id="edit" class="control fa fa-pencil-square-o"></button>
                    <button id="save" class="control fa fa-floppy-o"></button>
                </div>
                <h2>Strixhaven Star</h2>
                <div id="topcontainer" class="topcontainer">
                    <div class="issue"></div>
                    <div class="slogan"></div>
                    <div class="paperdate"></div>
                </div>
                <div class="bodycontainer">
                    <div id="leftc" class="LCorn" style="display: none" onclick="previouspg()"></div>
                    <div id="rightc" class="RCorn" style="display: block" onclick="nextpg()"></div>

                    <select id="srcSelector" class="srcSelector">
                        <option value="defSSvideo.mp4">Circle Time</option>
                        <option value="strix_star_vid.mp4">Welcome to Strixhaven</option>
                    </select>
                    <div id="page1" class="sspage pg1" style="display: block">
                        <div class="contentContainer">
                            <h1 class="Mainheadline"></h1>
                            <div class="secContainer">
                                <div id="pg1left" class="leftcol">
                                    <video src="" type="video/mp4" muted autoplay loop></video>
                                </div>
                                <div id="one" class="right"></div>
                            </div>
                        </div>
                    </div>

                    <div id="page2" class="sspage pg2" style="display: none">
                        <div class="contentContainer">
                            <div id="pg2left" class="left"></div>
                            <div class="midwrapper">
                                <div id="pg2Mtop" class="top"></div>
                                <div id="pg2Mbot" class="bot"></div>
                            </div>
                            <div id="pg2right" class="right"></div>
                        </div>
                    </div>

                    <div id="page3" class="pg3" style="display: none">
                        <div id="joblisting" class="jobs scrollbar">
                        </div>
                    </div>
                </div>
            </div>

            <div class="page" id="npcs" hidden>
                <h2>NPCs</h2>
                <div class="controls">
                    <button id="add" class="control fa fa-plus"></button>
                    <button id="edit" class="control fa fa-pencil-square-o"></button>
                    <button id="save" class="control fa fa-floppy-o"></button>
                    <button id="delete" class="control fa fa-trash"></button>
                </div>
                <div class="npcProfile">
                    <div class="student">
                        <form id="profileform1" class="Vscrollbar">
                            <h3>Students</h3>
                            <div class="npcSelector">
                                <select id="npcList2">
                                    <option value="0">-- Please Select a NPC --</option>
                                </select>
                            </div>
                            <input id="nid" hidden />
                            <label><p>Name:</p><input id="name" placeholder="Name" disabled /></label>
                            <label><p>Age:</p><input id="age" placeholder="Age" disabled /></label>
                            <label><p>Gender:</p><input id="gender" placeholder="Gender" disabled /></label>
                            <label><p>Race:</p><input id="race" placeholder="Race" disabled /></label>
                            <label><p>Subrace:</p><input id="subrace" placeholder="Subrace" disabled /></label>
                            <label><p>Alignment:</p><input id="alignment" placeholder="Alignment" disabled /></label>
                            <label><p>Hair Colour:</p><input id="haircolour" placeholder="Hair Colour" disabled /></label>
                            <label><p>Eye Colour:</p><input id="eyecolour" placeholder="Eye Colour" disabled /></label>
                            <label><p>Height:</p><input id="height" placeholder="Height" disabled /></label>
                            <label><p>Weight:</p><input id="weight" placeholder="Weight" disabled /></label>
                            <label><p>Year:</p><input id="year" placeholder="Year" disabled /></label>
                            <label><p>Boon:</p><input id="boon" placeholder="Boon" disabled /></label>
                            <label><p>Bane:</p><input id="bane" placeholder="Bane" disabled /></label>
                            <div class="note">
                                <p>Extra Notes:</p>
                                <textarea id="extranotes" class="scrollbar" placeholder="Extra Notes" readonly></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="teacher">
                        <form id="profileform2" class="Vscrollbar">
                            <h3>Teachers</h3>
                            <div class="npcSelector">
                                <select id="teacherList">
                                    <option value="0">-- Please Select a NPC --</option>
                                </select>
                            </div>
                            <input id="tid" hidden />
                            <label><p>Name:</p><input id="teacher_name" placeholder="Name" disabled /></label>
                            <label><p>Role:</p><input id="teacher_role" placeholder="Role" disabled /></label>
                            <label>
                                <p>School:</p><select id="schooldropdown" disabled>
                                    <option value="0">-- Teacher School --</option>
                                    <option value="lorehold">Lorehold</option>
                                    <option value="prismari">Prismari</option>
                                    <option value="silverquill">Silverquill</option>
                                    <option value="quandrix">Quandrix</option>
                                    <option value="witherbloom">Witherbloom</option>
                                </select>
                            </label>
                            <label><p>Type:</p><input id="teacher_type" placeholder="Type" disabled /></label>
                            <p></p>
                            <div class="note">
                                <p>Description:</p>
                                <textarea id="teacher_description" class="scrollbar" placeholder="Description" readonly></textarea>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="page extranotes" id="extra notes" hidden>
                <div class="controls">
                    <button id="save" class="control fa fa-floppy-o"></button>
                </div>
                <h2>Notes</h2>
                <div class="noteContainer">
                    <div class="notearea">
                        <h3>Year 1 Note</h3>
                        <textarea id="note"></textarea>
                    </div>
                    <div class="notearea">
                        <h3>Year 2 Note</h3>
                        <textarea id="note"></textarea>
                    </div>
                    <div class="notearea">
                        <h3>Year 3 Note</h3>
                        <textarea id="note"></textarea>
                    </div>
                    <div class="notearea">
                        <h3>Year 4 Note</h3>
                        <textarea id="note"></textarea>
                    </div>
                </div>
            </div>

            <div class="page" id="coming soon" hidden>
                <h2>Coming Soon</h2>
            </div>

            <div class="page" id="account" hidden>
                <h2>Account Details</h2>
                <form id="newPas">
                    <label for="CPW">Current Password</label>
                    <input id="CPW" placeholder="Current Password" type="password" />
                    <label for="NPW">New Password</label>
                    <input id="NPW" placeholder="New Password" type="password" />
                    <label for="CNPW">Confirm Password</label>
                    <input id="CNPW" placeholder="Confirm Password" type="password" />
                </form>
                <button id="newpas">Submit</button>
            </div>

            <div class="page" id="tea">
                <video src="../assets/Teacher_View.mp4" autoplay muted loop></video>
            </div>
        </div>
    </main>
</body>
</html>

<script src="https://code.jquery.com/jquery-3.6.1.js"></script>
<script src="/javascript/nav.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<script src="/javascript/login.js"></script>
<script src="/javascript/preload.js"></script>
<script src="/API/api.js"></script>

<script>
    var pageid = 'Professor DM';
    document.getElementById("pagename").innerHTML = pageid;
    $(async function () {
        loadPage();

        var tid = JSON.parse(sessionStorage.getItem("Teacher_Id"));
        if (tid) {
            await checkloadState('NPCData');
            await checkloadState('teacherNotes');
            await checkloadState('teachersData');
            await checkloadState('playersData');
            await checkloadState('playersExamData'); 
            await checkloadState('playersRelationshipData');

            getPreloadData();
            getSessionData();
        } else {
            window.location = 'login.html';
        }
    })
    async function checkloadState(toCheck) {
        var t = sessionStorage.getItem(toCheck);
        if (!t) {
            console.log(toCheck + " was not loaded");
            if (toCheck == 'NPCData') {
                await getNPCs();
            }
            if (toCheck == 'teacherNotes') {
                await getTeacherNotes();
            }
            if (toCheck == 'teachersData') {
                await getTeachers();
            }
            if (toCheck == 'playersData') {
                await getPlayers();
            }
            if (toCheck == 'playersExamData') {
                await getPlayersExams();
            }
            if (toCheck == 'playersRelationshipData') {
                await getPlayersRelationships();
            }
            
            setTimeout(() => {
                checkloadState(toCheck)
            }, "2000");
        } else {
            return true;
        }
    }

    function getPreloadData() {
        if (localStorage.getItem('newsdata')) {
            if (localStorage.getItem('jobdata')) {
                if (localStorage.getItem('campusClasses')) {
                    if (localStorage.getItem('campusColleges')) {
                        sort_PreloadedPaperData(JSON.parse(localStorage.getItem('newsdata')).value);
                        sort_PreloadedJobData(JSON.parse(localStorage.getItem('jobdata')).value);
                        sort_ClassDropdowns(JSON.parse(localStorage.getItem('campusClasses')).value);
                        sort_CollegeDropdowns(JSON.parse(localStorage.getItem('campusColleges')).value);
                    } else {
                        setTimeout(() => {
                            getPreloadData();
                        }, "500");
                    }
                } else {
                    setTimeout(() => {
                        getPreloadData();
                    }, "500");
                }
            } else {
                setTimeout(() => {
                    getPreloadData();
                }, "500");
            }
        } else {
            setTimeout(() => {
                getPreloadData();
            }, "500");
        }
    }
    function getSessionData() {
        if (sessionStorage.getItem('NPCData')) {
            if (sessionStorage.getItem('teacherNotes')) {
                if (sessionStorage.getItem('teachersData')) {
                    sort_NPCDropdown(JSON.parse(sessionStorage.getItem('NPCData')));
                    sort_Notes(JSON.parse(sessionStorage.getItem('teacherNotes')));
                    sort_Teachers(JSON.parse(sessionStorage.getItem('teachersData')));
                    sort_RelationshipDropdown(JSON.parse(sessionStorage.getItem('NPCData')));
                } else {
                    setTimeout(() => {
                        getSessionData();
                    }, "500");
                }
            } else {
                setTimeout(() => {
                    getSessionData();
                }, "500");
            }
        } else {
            setTimeout(() => {
                getSessionData();
            }, "500");
        }
    }

    // PreloadSorters
    function sort_PreloadedPaperData(data) {
        for (var x = 0; x < data.length; x++) {
            var story = data[x];
            var page = story['pageNo'];
            var location = story['location'];

            var title = story['title'];
            var content = story['content'];

            var id = "";
            if (location == "left") {
                id = 'pg2left';
            }
            if (location == "middle top") {
                id = 'pg2Mtop';
            }
            if (location == "middle bottom") {
                id = 'pg2Mbot';
            }
            if (location == "right") {
                id = 'pg2right';
            }
            if (location == "right") {
                id = 'pg2right';
            }

            const newTitle = document.createElement("input");
            newTitle.value = title;
            newTitle.disabled = "true";

            const newContent = document.createElement("textarea");
            newContent.value = content;
            newContent.readOnly = "true";

            // Get correct page
            var togoPage = document.getElementById('page' + page);

            if (page == 0) {
                var topc = document.getElementById('topcontainer');
                const newinput = document.createElement("input");
                newinput.value = content;
                newinput.classList = "topInputs";
                newinput.disabled = "true";

                if (location == "date") {
                    var date = topc.querySelector('.paperdate');
                    date.innerHTML = "";
                    date.appendChild(newinput);
                }
                if (location == "slogan") {
                    var slo = topc.querySelector('.slogan');
                    slo.innerHTML = "";
                    slo.appendChild(newinput);
                }
                if (location == "issue") {
                    var iss = topc.querySelector('.issue');
                    iss.innerHTML = "";
                    iss.appendChild(newinput);
                }
            } else if (page == 1) {
                if (title) {
                    togoPage.querySelector('.Mainheadline').appendChild(newTitle);
                    togoPage.querySelector('#' + location).appendChild(newContent);

                    // check if sec con is out of view.
                    var contentContainer = togoPage.querySelector('.secContainer');
                    var bounding = contentContainer.getBoundingClientRect();
                    if (bounding.bottom > (window.innerHeight || document.documentElement.clientHeight)) {
                        //get height of title
                        var headerH = togoPage.querySelector('.Mainheadline').offsetHeight;
                        var currentH = contentContainer.offsetHeight;
                        contentContainer.style.height = currentH - headerH;
                    }
                } else {
                    if (location == "dropdown") {
                        var drop = togoPage.parentElement.querySelector('select');
                        drop.value = content;
                        drop.disabled = "true";
                        togoPage.querySelector('video').src = "../assets/star/" + content;
                    }
                }
            } else {
                if (id) {
                    var col = togoPage.querySelector('#' + id);
                    newTitle.classList = "colTitle";
                    if (col) {
                        // Append Title to Col
                        col.appendChild(newTitle);
                        // Append Content to Col
                        col.appendChild(newContent);
                    }
                } else {
                    console.log(story);
                }
            }
        }
    }
    function sort_PreloadedJobData(data) {
        for (var x = 0; x < data.length; x++) {
            var job = data[x];
            var jloc = job["Location"];
            var jpay = job["Pay"];
            var jtit = job["Title"];
            var jid = job["id"];
            const newjob = document.createElement("div");
            const newtitle = document.createElement("input");
            const newdetails = document.createElement("div");
            const newlocation = document.createElement("input");
            const newpay = document.createElement("input");

            newtitle.value = jtit;
            newlocation.value = jloc;
            newpay.value = jpay;

            newtitle.disabled = "true";
            newlocation.disabled = "true";
            newpay.disabled = "true";

            newtitle.classList = "jtitle";
            newlocation.id = "jlocation";
            newpay.id = "jwage";

            newdetails.classList = "details";

            newdetails.appendChild(newlocation);
            newdetails.appendChild(newpay);

            newjob.appendChild(newtitle);
            newjob.appendChild(newdetails);

            newjob.classList = "job";
            newjob.id = jid;

            var page = document.querySelector(".pg3");
            page.querySelector('#joblisting').appendChild(newjob);
        }
    }
    function sort_ClassDropdowns(data) {
        for (var x = 0; x < data.length; x++) {
            var course = data[x]['class'];
            var teacher = data[x]['teacher'];

            var page = document.getElementById('courses');

            var selects = [];
            if (course['year'] == 1) {
                selects = page.querySelector('#Cyr1').querySelectorAll("select");
                if (course['required'] == "yes") {
                    $('#Y1S1 select').val(course['id'] + ":" + teacher['teacher_name']);
                    $('#Y1S1 select').attr("disabled", "true");
                    $('#Y1S1 p').text("Teacher: " + teacher['teacher_name']);
                }
            }
            if (course['year'] == 2) {
                selects = page.querySelector('#Cyr2').querySelectorAll("select");
                if (course['required'] == "yes") {
                    $('#Y2S1 select').val(course['id'] + ":" + teacher['teacher_name']);
                    $('#Y2S1 select').attr("disabled", "true");
                    $('#Y2S1 p').text("Teacher: " + teacher['teacher_name']);
                }
            }
            if (course['year'] == 3) {
                selects = page.querySelector('#Cyr3').querySelectorAll("select");
                if (course['required'] == "yes") {
                    $('#Y3S1 select').val(course['id'] + ":" + teacher['teacher_name']);
                    $('#Y3S1 select').attr("disabled", "true");
                    $('#Y3S1 p').text("Teacher: " + teacher['teacher_name']);
                }
            }
            if (course['year'] == 4) {
                selects = page.querySelector('#Cyr4').querySelectorAll("select");
                if (course['required'] == "yes") {
                    $('#Y4S1 select').val(course['id'] + ":" + teacher['teacher_name']);
                    $('#Y4S1 select').attr("disabled", "true");
                    $('#Y4S1 p').text("Teacher: " + teacher['teacher_name']);
                }
            }
            for (var y = 0; y < selects.length; y++) {
                var newOption = document.createElement('option');
                newOption.value = course['id'] + ":" + teacher['teacher_name'];
                newOption.text = course['name'];
                selects[y].addEventListener('change', setCourseTeacher, false);
                selects[y].add(newOption);
            }
        }

        // Sort all dropdowns
        var selects = page.querySelectorAll('select');
        for (var x = 0; x < selects.length; x++) {
            var selElem = selects[x];
            sortSelect(selElem);
        }
    }
    function sort_CollegeDropdowns(data) {
        var page = document.getElementById('players');
        var profile = page.querySelector('#profile');
        for (var y = 0; y < data.length; y++) {
            var col = data[y];
            var newCollege = document.createElement('option');
            newCollege.value = col['id'];
            newCollege.innerText = col['college_name'];
            profile.querySelector('#college').appendChild(newCollege);
        }
    }
    
    // Session Sorters
    function sort_NPCDropdown(data) {
        var npcPage = document.getElementById('npcs');
        for (var x = 0; x < data.length; x++) {
            var newOption = document.createElement('option');
            newOption.value = data[x].id;
            newOption.innerText = data[x].name;

            // NPC Page
            npcPage.querySelector('#npcList2').appendChild(newOption);
        }
    }
    function sort_Notes(data) {
        var page = document.getElementById('extra notes');
        var notes = page.querySelectorAll('textarea');
        for (var x = 0; x < data.length; x++) {
            var note = data[x];
            if (note.year == 1) {
                notes[0].value = note.note;
            }
            if (note.year == 2) {
                notes[1].value = note.note;
            }
            if (note.year == 3) {
                notes[2].value = note.note;
            }
            if (note.year == 4) {
                notes[3].value = note.note;
            }
        }
    }
    function sort_Teachers(data) {
        // CREATE NPC teacher list
        var npcPage = document.getElementById('npcs');
        for (var x = 0; x < data.length; x++) {
            var newOption = document.createElement('option');
            newOption.value = data[x].id;
            newOption.innerText = data[x].teacher_name;

            // NPC Page
            npcPage.querySelector('#teacherList').appendChild(newOption);
        }
    }
    function sort_RelationshipDropdown(data) {
        var relationshipPage = document.getElementById('relationships');
        for (var x = 0; x < data.length; x++) {
            var newOption = document.createElement('option');
            newOption.value = data[x].id;
            newOption.innerText = data[x].name;

            // NPC Page
            relationshipPage.querySelector('#addRelationNPCs').appendChild(newOption);
            sortSelect(relationshipPage.querySelector('#addRelationNPCs'));
        }
    }
    function sort_playerData(who, data1) {
        var data;
        for (var x = 0; x < data1.length; x++) {
            if (who == data1[x].player) {
                data = data1[x];
            }
        }

        var cLogo = document.getElementById('collegeLogo');
        var page = document.getElementById('players');
        var header = page.querySelector('h2');
        var profile = page.querySelector('#profile');
        var details = page.querySelector('#details');

        // Title
        header.innerText = "Player: " + data.player;
        if (cLogo) {
            if (data.college == 6) {
                cLogo.src = "assets/strix_logo.png";
            }
            if (data.college == 5) {
                cLogo.src = "assets/maps/witherbloom.png";
            }
            if (data.college == 4) {
                cLogo.src = "assets/maps/silverquill.png";
            }
            if (data.college == 3) {
                cLogo.src = "assets/maps/quandrix.png";
            }
            if (data.college == 2) {
                cLogo.src = "assets/maps/prismari.png";
            }
            if (data.college == 1) {
                cLogo.src = "assets/maps/lorehold.png";
            }
        }
        // Profile
        profile.querySelector('#pid').value = data.id;
        profile.querySelector('#player').value = data.player;
        profile.querySelector('#profilepicture').src = "assets/students/players/" + data.picture;
        profile.querySelector('#name').value = data.name;
        profile.querySelector('#age').value = data.age;
        profile.querySelector('#gender').value = data.gender;
        profile.querySelector('#race').value = data.race;
        profile.querySelector('#subrace').value = data.subrace;
        profile.querySelector('#alignment').value = data.alignment;
        profile.querySelector('#haircolour').value = data.haircolour;
        profile.querySelector('#eyecolour').value = data.eyecolour;
        profile.querySelector('#height').value = data.height;
        profile.querySelector('#weight').value = data.weight;
        profile.querySelector('#level').value = data.level;
        profile.querySelector('#class').value = data.class;
        profile.querySelector('#subclass').value = data.subclass;
        profile.querySelector('#background').value = data.background;
        profile.querySelector('#year').value = data.year;
        profile.querySelector('#college').value = data.college;
        profile.querySelector('#personalitytraits').value = data.personalitytraits;
        profile.querySelector('#ideals').value = data.ideals;
        profile.querySelector('#bonds').value = data.bonds;
        profile.querySelector('#flaws').value = data.flaws;
        profile.querySelector('#goals').value = data.goals;
        profile.querySelector('#backgroundfeatures').value = data.backgroundfeatures;
        profile.querySelector('#appearance').value = data.appearance;
        // Details
        details.querySelector('#backstory').value = data.backstory;
        details.querySelector('#extranotes').value = data.extranotes;
        // Courses
        var allclasses = JSON.parse(localStorage.getItem('playersClassData'));
        var classes = [];
        for (var y = 0; y < allclasses.length; y++) {
            if (allclasses[y].student.id == data.id) {
                classes.push(allclasses[y]);
            }
        }
        sort_playerClass(classes);
        // Exams
        var allexams = JSON.parse(sessionStorage.getItem('playersExamData'));
        var exams = [];
        for (var y = 0; y < allexams.length; y++) {
            if (allexams[y].student.id == data.id) {
                exams.push(allexams[y]);
            }
        }
        sort_playerExams(exams);
        // Job and Extras
        var jobs = JSON.parse(localStorage.getItem('playersJobData'));
        for (var y = 0; y < jobs.length; y++) {
            if (jobs[y].Student.id == data.id) {
                sort_playerJob(jobs[y]);
            }
        }
        var allclubs = JSON.parse(localStorage.getItem('playersClubData'));
        var clubs = [];
        for (var y = 0; y < allclubs.length; y++) {
            if (allclubs[y].student.id == data.id) {
                clubs.push(allclubs[y]);
            }
        }
        sort_playerClub(clubs);
        // Relationships
        var allrel = JSON.parse(sessionStorage.getItem('playersRelationshipData'));
        var rels = [];
        for (var y = 0; y < allrel.length; y++) {
            if (allrel[y].student.id == data.id) {
                rels.push(allrel[y]);
            }
        }
        sort_playerRelationships(rels);
    }
    function sort_playerClass(data) {
        var Y1C = 1;
        var Y2C = 1;
        var Y3C = 1;
        var Y4C = 1;

        for (var x = 0; x < data.length; x++) {
            var course = data[x]['class'];
            var student = data[x]['student'];

            if (course['year'] == 1) {
                var classChoice = "Y1S" + Y1C;
                Y1C++;
            }
            if (course['year'] == 2) {
                var classChoice = "Y2S" + Y2C;
                Y2C++;
            }
            if (course['year'] == 3) {
                var classChoice = "Y3S" + Y3C;
                Y3C++;
            }
            if (course['year'] == 4) {
                var classChoice = "Y4S" + Y4C;
                Y4C++;
            }
            $('#' + classChoice + ' select > option').each(function () {
                var split = $(this).val().split(":");
                var courseId = split[0];
                var teacher = split[1];

                if (courseId == course['id']) {
                    $('#' + classChoice + ' select').val(course['id'] + ":" + teacher).change();
                    $('#' + classChoice + ' select').attr("disabled", "true");
                    $('#' + classChoice + ' p').text("Teacher: " + teacher);
                }
            });
        }
    }
    function sort_playerExams(data) {
        var examsPage = document.getElementById('exams');
        var examExams = examsPage.querySelectorAll('.exams');
        for (var x = 0; x < data.length; x++) {
            var results = data[x];

            var newExam = document.createElement("div");
            var newTitle = document.createElement("p");
            var newDropDown = document.createElement("select");
            var newDice = document.createElement("p");
            var newSkills = document.createElement("p");

            var options = ['-- Ungraded --', 'Fail', 'Pass', 'Ace'];
            var values = ['null', 'fail', 'pass', 'ace'];
            for (var z = 0; z < options.length; z++) {
                var newDropOption = document.createElement("option");
                newDropOption.innerText = options[z];
                newDropOption.value = values[z];

                newDropDown.appendChild(newDropOption);
                newDropDown.addEventListener('change', changeDice, false);
            }

            var score = 0;
            if (results['score']) {
                if (results['score'] == "pass") {
                    score = 1;
                }
                if (results['score'] == "ace") {
                    score = 2;
                }
            }

            newTitle.innerText = results['exam']['name'];
            newDice.innerText = score + "d4";
            newDice.id = "dice";
            newSkills.innerText = results['exam']['skill'];

            newExam.id = "exam" + results['exam']['id'];

            newExam.appendChild(newTitle);
            newExam.appendChild(newDropDown);
            newExam.appendChild(newDice);
            newExam.appendChild(newSkills);

            examExams[results['exam']['year'] - 1].appendChild(newExam);

            var t = document.getElementById("exam" + results['exam']['id']);
            if (results['score']) {
                t.querySelector('select').value = results['score'];
            }
        }
    }
    function sort_playerJob(data) {
        var currentJob = document.getElementById('jobs');
        const theJob = document.createElement('div');
        const theTitle = document.createElement('p');
        const theLocation = document.createElement('p');
        const theWage = document.createElement('input');
        const theCoworker = document.createElement('p');
        const QuitButton = document.createElement('button');

        var job = data.Job;

        theJob.classList = "job";
        theJob.id = "job";
        QuitButton.classList = "quit";
        QuitButton.id = data.Student.id;
        QuitButton.innerText = "Fire";
        QuitButton.addEventListener('click', fireFromJob, false);

        theTitle.innerText = job.Title;
        theTitle.classList = "title";

        theLocation.innerText = job.Location;
        theLocation.classList = "location";

        theWage.value = data.wage;
        theWage.classList = "wage";
        theWage.addEventListener('change', saveWage, false);

        _supabase.from('Job<>Student').select('Student (id, name, player)').eq('Job', job['id']).then(response => {
            var allworkers = response.data;
            var wcount = 0;
            var coworkers = "";
            if (allworkers) {
                for (var y = 0; y < allworkers.length; y++) {
                    var worker = allworkers[y]['Student'];
                    if (document.getElementById('profile').querySelector('#profileform1').querySelector('#pid').value != worker['id']) {
                        if (wcount > 0) {
                            coworkers = coworkers + " & " + worker['name'];
                        } else {
                            coworkers = worker['name'];
                        }
                        wcount++;
                    }
                }
            }
            theCoworker.innerText = coworkers;
            theCoworker.classList = "coworker";

            theJob.appendChild(theTitle);
            theJob.appendChild(theLocation);
            theJob.appendChild(theCoworker);
            theJob.appendChild(theWage);
            theJob.appendChild(QuitButton);
            currentJob.appendChild(theJob);
        })
    }
    function sort_playerClub(data1) {
        if (data1.length > 0) {
            var clubs = document.getElementById('clubs');
            for (var x = 0; x < data1.length; x++) {
                var data = data1[x];
                var club = data['club'];
                var sid = data.student.id;

                var clubid = club['id'];
                var clubname = club['name'];
                var clubskills = club['skills'];

                const theClub = document.createElement('div');
                const theClubName = document.createElement('p');
                const theClubSkill = document.createElement('p');
                const theClubDice = document.createElement('p');
                const theClubMembers = document.createElement('div');

                const theClubQuit = document.createElement('button');

                theClub.classList = "club";

                theClubName.classList = "clubname";
                theClubName.innerText = clubname;

                theClubSkill.classList = "clubskill";
                theClubSkill.innerText = clubskills;

                theClubDice.classList = "dice";
                theClubDice.innerText = "1d4";

                theClubMembers.classList = "members scrollbar";

                _supabase.from('Club<>Student').select('student (id, name)').eq('club', clubid).then(response => {
                    for (var y = 0; y < response.data.length; y++) {
                        if (sid != response.data[y]['student']['id']) {
                            const theClubMember = document.createElement('p');
                            theClubMember.classList = "member";
                            theClubMember.innerText = response.data[y]['student']['name'];
                            theClubMembers.appendChild(theClubMember);
                        }
                    }
                })

                theClubQuit.classList = "quit";
                theClubQuit.innerText = "Quit Club";
                theClubQuit.id = clubid;
                theClubQuit.addEventListener('click', kickFromClub, false);

                theClub.appendChild(theClubName);
                theClub.appendChild(theClubSkill);
                theClub.appendChild(theClubDice);
                theClub.appendChild(theClubMembers);

                theClub.appendChild(theClubQuit);

                clubs.appendChild(theClub);
            }
        }
    }
    function sort_playerRelationships(data1) {
        var relationshipPage = document.getElementById('relationships');
        var addSelected = relationshipPage.querySelector('select');
        var page = relationshipPage.querySelector('#cubes');
        page.innerHTML = "";
        for (var x = 0; x < data1.length; x++) {
            var data = data1[x];
            const newCube = document.createElement("div");
            const newName = document.createElement("p");

            const newScore = document.createElement("div");
            const newRelationship = document.createElement("div");
            const newBoon = document.createElement("div");
            const newBane = document.createElement("div");

            const newDeleteBtn = document.createElement("button");

            const newScoreSpan = document.createElement("span");
            const newRelationshipSpan = document.createElement("span");
            const newBoonSpan = document.createElement("span");
            const newBaneSpan = document.createElement("span");

            newName.innerText = data['npc']['name'];

            newScoreSpan.innerText = "Relationship Score: ";
            newScoreSpan.classList = "scoreTitle";
            newScore.appendChild(newScoreSpan);
            const newInput = document.createElement("input");
            newInput.value = data['relationship'];
            newInput.disabled = "true";
            newScore.appendChild(newInput);

            var text = "";
            if (data['relationship'] >= "-100") {
                if (data['relationship'] >= 8) {
                    text = "Lover";
                } else if (data['relationship'] >= "3") {
                    text = "Friend";
                } else if (data['relationship'] >= "0") {
                    text = "Neutral";
                } else {
                    text = "Rival";
                }
            }
            newRelationshipSpan.innerText = "Relationship: ";
            newRelationship.appendChild(newRelationshipSpan);
            var newTextRelationship = document.createElement('p');
            newTextRelationship.innerText = " " + text;
            newRelationship.appendChild(newTextRelationship);

            newBoonSpan.innerText = "Boon: ";
            newBoon.appendChild(newBoonSpan);
            var newTextBoon = document.createElement('p');
            newTextBoon.innerText = " " + data['npc']['boon'];
            newBoon.appendChild(newTextBoon);

            newBaneSpan.innerText = "Bane: ";
            newBane.appendChild(newBaneSpan);
            var newTextBane = document.createElement('p');
            newTextBane.innerText = " " + data['npc']['bane'];
            newBane.appendChild(newTextBane);

            newDeleteBtn.classList = "fa fa-trash";
            newDeleteBtn.addEventListener('click', removeRelationship, false);

            newCube.classList = "cube";
            newCube.id = data['npc']['id'];

            newName.classList = "cName";

            newCube.appendChild(newName);
            newCube.appendChild(newScore);
            newCube.appendChild(newRelationship);
            newCube.appendChild(newBoon);
            newCube.appendChild(newBane);
            newCube.appendChild(newDeleteBtn);

            page.appendChild(newCube);

            var options = addSelected.querySelectorAll("option");
            for (var y = 0; y < options.length; y++) {
                if (options[y].value == data['npc']['id']) {
                    options[y].remove();
                }
            }
        }
    }

    // Removers
    function deleteStudent(id) {
        // Club
        _supabase.from('Club<>Student').delete().match({ student: id }).then(response => {
            // Job
            _supabase.from('Job<>Student').delete().match({ Student: id }).then(response => {
                // Relationship
                _supabase.from('npc<>student').delete().match({ npc: id }).then(response => {
                    // Student Table
                    _supabase.from('_tblStudents').delete().match({ id: id }).then(response => {
                        removeStorage('NPCData');
                        reloadPage();
                    })
                })
            })
        })
    }
    function removeRelationship() {
        removeStorage('playersRelationshipData');
        var nid = this.parentElement.id;
        var sid = document.getElementById('profile').querySelector('#pid').value;
        _supabase.from('npc<>student').delete().match({ npc: nid, student: sid }).then(response => {
            
            getPlayersRelationships();
        })
    }

    // Local Functions
    var dropdowns = [];
    var dropdown = document.getElementsByClassName("dropdown-btn");
    var subdown = document.getElementsByClassName("subbtn");
    for (var i = 0; i < dropdown.length; i++) {
        dropdowns.push(dropdown[i]);
    }
    for (var i = 0; i < subdown.length; i++) {
        dropdowns.push(subdown[i]);
    }
    for (var i = 0; i < dropdowns.length; i++) {
        dropdowns[i].addEventListener("click", openSubElements);
    }
    function openSubElements() {
        var dropdownContent = this.nextElementSibling;
        var subDrops = this.parentNode.querySelectorAll('.subbtn');

        if (subDrops) {
            for (var x = 0; x < subDrops.length; x++) {
                if (subDrops[x].classList == 'subbtn active') {
                    if (subDrops[x] != this) {
                        subDrops[x].classList.toggle("active");
                        subDrops[x].nextElementSibling.style.display = "none";
                    }
                }
            }
        }

        this.classList.toggle("active");
        if (dropdownContent.style.display === "block") {
            dropdownContent.style.display = "none";
        } else {
            dropdownContent.style.display = "block";
        }
    }

    function loadPage() {
        // Load last page saved on
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        const toOpen = urlParams.get('page');
        if (toOpen) {
            var allPages = document.getElementById('pages').querySelectorAll(".page");
            var allChoices = document.getElementById('subnavchoices').querySelectorAll(".choice");
            for (var x = 0; x < allPages.length; x++) {
                allPages[x].setAttribute("hidden", "true");
            }
            for (var x = 0; x < allChoices.length; x++) {
                allChoices[x].classList = "choice";
                if (allChoices[x].innerText.toLowerCase() == toOpen) {
                    allChoices[x].classList = "choice selected";
                }
            }
            if (toOpen == "players") {
                const subOpen = urlParams.get('subpage');
                const player = urlParams.get('p');
                var views = document.getElementById('players').querySelectorAll('.view');
                for (var y = 0; y < views.length; y++) {
                    views[y].setAttribute("hidden", "true");
                    if (views[y].id == subOpen) {
                        views[y].toggleAttribute("hidden");
                    }
                }
                _supabase.from('_tblStudents').select('player').eq("id", player).then(response => {
                    var p = response.data[0]['player'];
                    filter_playerData(p, JSON.parse(sessionStorage.getItem('playersData')));
                })
            }
            // Reset URL
            window.history.pushState("object or string", "Title", "/teacherview.html");

            // Show Page
            document.getElementById(toOpen).toggleAttribute("hidden");
        }
    }
    function reloadPage() {
        var allPages = document.getElementById('pages').querySelectorAll(".page");
        for (var x = 0; x < allPages.length; x++) {
            if (allPages[x].checkVisibility()) {
                var currentPage = allPages[x].id;
                const urlParams = new URLSearchParams(window.location.search);
                urlParams.set('page', currentPage);
                if (currentPage == "players") {
                    var views = document.getElementById('players').querySelectorAll('.view');
                    for (var y = 0; y < views.length; y++) {
                        if (!views[y].hidden) {
                            urlParams.set('subpage', views[y].id);
                        }
                    }
                    urlParams.set('p', document.getElementById('profile').querySelector('#pid').value)
                }
                window.location.search = urlParams;
            }
        }
    }
    function cleanNPC(toclean) {
        var mainpage = document.getElementById('pages');
        var NPCpage = mainpage.querySelector('#npcs');
        var NPCstudent = NPCpage.querySelector('.student');
        var NPCteacher = NPCpage.querySelector('.teacher');

        if (toclean == "teacher") {
            var inputs = NPCteacher.querySelectorAll("input");
            var selects = NPCteacher.querySelectorAll("select");
            var textareas = NPCteacher.querySelectorAll("textarea");
        }
        if (toclean == "student") {
            var inputs = NPCstudent.querySelectorAll("input");
            var selects = NPCstudent.querySelectorAll("select");
            var textareas = NPCstudent.querySelectorAll("textarea");
        }
        for (var x = 0; x < inputs.length; x++) {
            inputs[x].value = "";
        }
        for (var x = 0; x < selects.length; x++) {
            selects[x].value = "0";
        }
        for (var x = 0; x < textareas.length; x++) {
            textareas[x].value = "";
        }
    }
    function getNPCStudentDataByID(who, data) {
        for (var x = 0; x < data.length; x++) {
            if (data[x].id == who) {
                var page = document.getElementById('npcs');
                var NPCprofile = page.querySelector('.student');
                NPCprofile.querySelector('#nid').value = data[x].id;
                NPCprofile.querySelector('#name').value = data[x].name;
                NPCprofile.querySelector('#age').value = data[x].age;
                NPCprofile.querySelector('#gender').value = data[x].gender;
                NPCprofile.querySelector('#race').value = data[x].race;
                NPCprofile.querySelector('#subrace').value = data[x].subrace;
                NPCprofile.querySelector('#alignment').value = data[x].alignment;
                NPCprofile.querySelector('#haircolour').value = data[x].haircolour;
                NPCprofile.querySelector('#eyecolour').value = data[x].eyecolour;
                NPCprofile.querySelector('#height').value = data[x].height;
                NPCprofile.querySelector('#weight').value = data[x].weight;
                NPCprofile.querySelector('#year').value = data[x].year;
                NPCprofile.querySelector('#boon').value = data[x].boon;
                NPCprofile.querySelector('#bane').value = data[x].bane;
                NPCprofile.querySelector('#extranotes').value = data[x].extranotes;
            }
        }
    }
    function getNPCTeacherDataByID(who, data) {
        for (var x = 0; x < data.length; x++) {
            if (data[x].id == who) {
                var page = document.getElementById('npcs');
                var TPCprofile = page.querySelector('.teacher');
                TPCprofile.querySelector('#tid').value = data[x].id;
                TPCprofile.querySelector('#teacher_name').value = data[x].teacher_name;
                TPCprofile.querySelector('#teacher_role').value = data[x].teacher_role;
                TPCprofile.querySelector('#schooldropdown').value = data[x].teacher_school;
                TPCprofile.querySelector('#teacher_type').value = data[x].teacher_type;
                TPCprofile.querySelector('#teacher_description').value = data[x].teacher_description;
            }
        }
    }
    function togglecurrent() {
        var mainpage = document.getElementById('pages');
        var pages = mainpage.querySelectorAll('.page');

        for (var x = 0; x < pages.length; x++) {
            if (pages[x]) {
                if (window.getComputedStyle(pages[x]).display != "none") {
                    if (pages[x].id == "players") {
                        var views = pages[x].querySelectorAll('.view');
                        for (var y = 0; y < views.length; y++) {
                            if (views[y].getAttribute('hidden') == null) {
                                var inputs = views[y].querySelectorAll('input');
                                var textareas = views[y].querySelectorAll('textarea');
                                var selects = views[y].querySelectorAll('select');
                                for (var z = 0; z < inputs.length; z++) {
                                    inputs[z].toggleAttribute("disabled");
                                }
                                for (var z = 0; z < textareas.length; z++) {
                                    textareas[z].toggleAttribute("readonly");
                                }
                                for (var z = 0; z < selects.length; z++) {
                                    selects[z].toggleAttribute("disabled");
                                }
                            }
                        }
                    } else {
                        var inputs = pages[x].querySelectorAll('input');
                        var textareas = pages[x].querySelectorAll('textarea');
                        var selects = pages[x].querySelectorAll('select');
                        for (var y = 0; y < inputs.length; y++) {
                            inputs[y].toggleAttribute("disabled");
                        }
                        for (var y = 0; y < textareas.length; y++) {
                            textareas[y].toggleAttribute("readonly");
                        }
                        for (var y = 0; y < selects.length; y++) {
                            selects[y].toggleAttribute("disabled");
                        }
                    }
                }
            }
        }
    }
    function toshow(id) {
        var send = 0;
        if (id == "one") {
            send = 0;
        }
        if (id == "two") {
            send = 1;
        }
        if (id == "three") {
            send = 2;
        }
        if (id == "four") {
            send = 3;
        }
        return send;
    }
    function cleanPages() {
        var profile = document.getElementById('profile');
        var detail = document.getElementById('details');
        var courses = document.getElementById('courses');
        var exams = document.getElementById('exams');
        var job = document.getElementById('jobs');
        var club = document.getElementById('clubs');

        var courseYear = courses.querySelectorAll('.year');
        for (var x = 0; x < courseYear.length; x++) {
            var selectors = courseYear[x].querySelectorAll("select");
            var text = courseYear[x].querySelectorAll("p");
            var manditory = ['Y1S1', 'Y2S1', 'Y3S1', 'Y4S1'];
            for (var z = 0; z < manditory.length; z++) {
                for (var y = 0; y < selectors.length; y++) {
                    if (selectors[y].parentElement.id != manditory[z]) {
                        selectors[y].value = '0';
                        selectors[y].disabled = false;
                        text[y].innerHTML = "";
                    }
                }
            }
        }

        var courseExams = exams.querySelectorAll('.exams');
        for (var x = 0; x < courseExams.length; x++) {
            courseExams[x].innerHTML = " ";
        }

        job.innerHTML = "";
        club.innerHTML = "";
    }
    function setNewPass() {
        var Form = document.getElementById('newPas');
        if (Form.querySelector('#NPW').value != "") {
            // Check Confirm Password
            if (Form.querySelector('#NPW').value == Form.querySelector('#CNPW').value) {
                if (Form.querySelector('#NPW').value != "testing") {
                    var id = "";
                    if (sessionStorage.getItem("Teacher_Id")) {
                        id = sessionStorage.getItem("Teacher_Id");
                    }
                    // Check Current Password is Correct
                    _supabase.from('_tblLogin').select('log_use').eq('teacher_id', id).eq('log_pas', Form.querySelector('#CPW').value).then(response => {
                        if (response.data.length > 0) {
                            // Update Password
                            _supabase.from('_tblLogin').update({ log_pas: Form.querySelector('#NPW').value }).eq('teacher_id', id).eq('log_pas', Form.querySelector('#CPW').value).then(response => {
                                alert("Your password has been updated");
                            })
                        }
                    });
                }
            }
        }
    }

    var showing = 0;
    var pages = ["page1", "page2", "page3"];
    function toggleshow(el) {
        var element = document.getElementById(el);
        element.style.display = "none";
    }
    function nextpg() {
        if (showing < 2) {
            for (var x = 0; x < pages.length; x++) {
                toggleshow(pages[x]);
            }
            showing++;
            var toshow = document.getElementById(pages[showing]);
            var preBtn = document.getElementById('leftc');
            var dropdown = document.getElementById('srcSelector');
            var nexBtn = document.getElementById('rightc');
            if (showing == 2) {
                toshow.style.display = "flex";
                nexBtn.style.display = "none";
            }
            preBtn.style.display = "block";
            dropdown.style.display = "none";
            toshow.style.display = "flex";
        }
    }
    function previouspg() {
        if (showing > 0) {
            for (var x = 0; x < pages.length; x++) {
                toggleshow(pages[x]);
            }
            showing--;
            var toshow = document.getElementById(pages[showing]);
            var preBtn = document.getElementById('leftc');
            var dropdown = document.getElementById('srcSelector');
            var nexBtn = document.getElementById('rightc');
            if (showing == 0) {
                dropdown.style.display = "block";
                toshow.style.display = "block";
                preBtn.style.display = "none";
            } else {
                toshow.style.display = "flex";
                nexBtn.style.display = "block";
            }
        }
    }
    function sortSelect(selElem) {
        var tmpAry = new Array();
        for (var i = 0; i < selElem.options.length; i++) {
            tmpAry[i] = new Array();
            tmpAry[i][0] = selElem.options[i].text;
            tmpAry[i][1] = selElem.options[i].value;
        }
        tmpAry.sort();
        while (selElem.options.length > 0) {
            selElem.options[0] = null;
        }
        for (var i = 0; i < tmpAry.length; i++) {
            var op = new Option(tmpAry[i][0], tmpAry[i][1]);
            selElem.options[i] = op;
        }
        return;
    }
    function changeDice() {
        var dice = this.parentElement.querySelector("#dice");
        if (this.value == 'pass') {
            dice.innerText = "1d4";
        }
        if (this.value == 'fail') {
            dice.innerText = "0d4";
        }
        if (this.value == 'ace') {
            dice.innerText = "2d4";
        }
    }
    function setCourseTeacher() {
        var textarea = this.parentElement.querySelector(".classTeacher");
        var data = this.value;
        textarea.innerText = "Teacher: " + data.split(':')[1];
    }

    //// Controls
    // Subnav
    $('.choice').click(function () {
        var subnav = document.getElementById('subnavchoices');
        var choices = subnav.querySelectorAll('.choice');
        var current = "no";
        if (this.classList == "choice selected") {
            current = "yes";
        }
        for (var x = 0; x < choices.length; x++) {
            choices[x].classList = "choice";
        }
        var choice = this.querySelector('p');
        var toshow = choice.innerText.toLowerCase();
        if (current == "no") {
            this.classList = "choice selected";

            if (toshow == "logout") {
                logot();
            }

            var mainpage = document.getElementById('pages');
            var pages = mainpage.querySelectorAll('.page');
            for (var x = 0; x < pages.length; x++) {
                if (pages[x]) {
                    pages[x].setAttribute("hidden", "true");
                }
            }
            if (this.id != "ppp") {
                var cLogo = document.getElementById('collegeLogo');
                cLogo.src = "assets/strix_logo.png";
            }
            document.getElementById(toshow).toggleAttribute("hidden");
        } else {
            var pages = document.getElementById("pages").querySelectorAll(".page");
            if (toshow != 'players') {
                for (var x = 0; x < pages.length; x++) {
                    pages[x].setAttribute("hidden", "true");
                }
                document.getElementById("tea").toggleAttribute("hidden");
            }
        }
    })
    $('.subbtn').click(function () {
        var toget = this.innerText;
        cleanPages();

        sort_playerData(toget, JSON.parse(sessionStorage.getItem('playersData')));
    })
    $('.subNavChoice').click(function () {
    var selectedView = this.innerText.toLowerCase();
    if (selectedView == "job and extras") {
        selectedView = 'jobandextras';
    }
    var Views = document.getElementById('players').querySelector('.mainbody').querySelectorAll('.view');
    var page = document.getElementById('players');
    var profile = page.querySelector('#profile');
    for (var x = 0; x < Views.length; x++) {
        Views[x].setAttribute("hidden", "true");
        if (Views[x].id == selectedView) {
            if (selectedView == "Job and Extras") {
                page.querySelector('h2').innerText = "Job";
            } else {
                var p = "Player: " + profile.querySelector('#player').value;
                page.querySelector('h2').innerHTML = p;
            }
            Views[x].toggleAttribute("hidden");
        }
    }
    })
    // SS
    $('.srcSelector').change(function () {
        this.parentElement.parentElement.querySelector('video').src = "../assets/star/" + this.value;
    })
    // NPCs
    $('#npcs #npcList2').change(function () {
        cleanNPC('teacher');
        getNPCStudentDataByID(this.value, JSON.parse(sessionStorage.getItem('NPCData')));
    })
    $('#npcs #teacherList').change(function () {
        cleanNPC('student');
        getNPCTeacherDataByID(this.value, JSON.parse(sessionStorage.getItem('teachersData')));
    })
    // Relationships
    $('#cancleRelation').click(function () {
        // Closes add relationship model
        var page = this.parentElement.parentElement;
        page.querySelector('#addModel').toggleAttribute('hidden');
        var addloc = page.querySelector('.controls').querySelector('#add');
        addloc.classList = "fa fa-plus";
    })
    $('#confirmRelation').click(async function () {
        var nid = this.parentElement.querySelector('#addRelationNPCs').value;
        var sid = document.getElementById('profile').querySelector('#pid').value;
        this.parentElement.querySelector('#addRelationNPCs').value = 0;
        this.parentElement.toggleAttribute('hidden');
        var addloc = this.parentElement.parentElement.querySelector('.controls').querySelector('#add');
        addloc.classList = "fa fa-plus";
        createRelationship(nid, sid);
    })
    $('.control').click(function () {
        var page = this.parentNode.parentNode;
        if (this.id == "add") {
            // Get location of add btn
            var addloc = this.parentElement.parentElement.id;

            // Check to see if edit is an option
            var editbtn = document.getElementById(addloc).querySelector('#edit');
            if (editbtn) {
                editbtn.classList = "control fa fa-pencil-square-o";
            }

            // Toggle add btn and page
            if (this.classList != "fa fa-plus activecontrol") {
                this.classList = "fa fa-plus activecontrol";
            } else {
                this.classList = "control fa fa-plus";
            }

            if (addloc == "npcs") {
                togglecurrent();
            }
            if (addloc == "relationships") {
                var page = this.parentElement.parentElement;
                page.querySelector('#addModel').toggleAttribute('hidden');
            }
        }
        if (this.id == "edit") {
            // Get location of edit btn
            var editloc = this.parentElement.parentElement.id;

            // Check to see if add is an option
            var addbtn = document.getElementById(editloc).querySelector('#add');
            if (addbtn) {
                addbtn.classList = "control fa fa-plus";
            }

            if (this.classList != "fa fa-pencil-square-o activecontrol") {
                this.classList = "fa fa-pencil-square-o activecontrol";
                togglecurrent();
            } else {
                this.classList = "control fa fa-pencil-square-o";
                togglecurrent();
            }
        }
        if (this.id == "save") {
            this.disabled;
            var saveloc = this.parentElement.parentElement.id;
            if (!saveloc) {
                saveloc = this.parentElement.parentElement.parentElement.parentElement.id;
            }
            var editbtn = page.querySelector('#edit');
            var addbtn = page.querySelector('#add');
            var active = "";
            var bothselected = "no";

            if (editbtn && addbtn) {
                if (addbtn.classList == "fa fa-plus activecontrol" && editbtn.classList == "fa fa-pencil-square-o activecontrol") {
                    bothselected = "yes";
                }
            }
            // Catch
            if (bothselected == "no") {
                if (editbtn) {
                    if (editbtn.classList != "control fa fa-pencil-square-o") {
                        togglecurrent();
                        editbtn.classList = "control fa fa-pencil-square-o";
                        active = "edit";
                    }
                }
                if (addbtn) {
                    if (addbtn.classList != "control fa fa-plus") {
                        addbtn.classList = "control fa fa-plus";
                        active = "add";
                    }
                }

                // Player
                if (saveloc == "profile") {
                    var inputs = this.parentElement.parentElement.querySelectorAll('select');
                    saveStudentSchool(inputs);
                }
                if (saveloc == "details") {
                }
                if (saveloc == "Cyr1" || saveloc == "Cyr2" || saveloc == "Cyr3" || saveloc == "Cyr4") {
                    var all = this.parentElement.parentElement.parentElement.parentElement;
                    var inputs = all.querySelectorAll('select');
                    saveCourseChoices(inputs);
                }
                if (saveloc == "exams") {
                    var exams = [];
                    var results = [];
                    var selects = page.querySelectorAll('select');
                    for (var y = 0; y < selects.length; y++) {
                        var select = selects[y];
                        var options = select.querySelectorAll('option');
                        for (var z = 0; z < options.length; z++) {
                            var option = options[z];
                            if (option.selected) {
                                if (option.value != 0) {
                                    var sec = select.parentElement.id.split('exam');
                                    exams.push(sec[1]);
                                    results.push(option.value);
                                }
                            }
                        }
                    }
                    saveExamScores(exams, results);
                }
                if (saveloc == "relationships") {
                    var cubeList = page.querySelector('#cubes');
                    var cubes = cubeList.querySelectorAll('.cube');
                    for (var x = 0; x < cubes.length; x++) {
                        saveRelationship(cubes[x]);
                    }
                }
                // Strixhaven Star
                if (saveloc == "strixhaven star") {
                    var pages = ['#page1', '#pg2left', '#pg2Mtop', '#pg2Mbot', '#pg2right'];
                    var pgHeader = [];
                    var pgContent = [];
                    var MainOptions = [];
                    for (var x = 0; x < pages.length; x++) {
                        var pg = page.querySelector(pages[x]);
                        if (pages[x] != "#topcontainer") {
                            pgHeader.push(pg.querySelector('input'));
                            pgContent.push(pg.querySelector('textarea'));
                        }
                    }
                    var pg = page.querySelector('#topcontainer');
                    MainOptions.push(pg.querySelectorAll('input'));
                    MainOptions.push(pg.parentElement.querySelector('select'));

                    saveSS(pages, pgHeader, pgContent, MainOptions);

                    var jobs = page.querySelector('.pg3').querySelector('.jobs').querySelectorAll('.job');
                    saveJobs(jobs);
                }
                // NPCs
                if (saveloc == "npcs") {
                    var allinputs = [];
                    var SorT = "";
                    if (this.parentElement.parentElement.querySelector('#nid').value) {
                        page = page.querySelector('.student');
                        SorT = "s";
                    }
                    if (this.parentElement.parentElement.querySelector('#tid').value) {
                        page = page.querySelector('.teacher');
                        SorT = "t";
                    }

                    if (active) {
                        var studnetName = page.querySelector('#name').value;
                        var teacherName = page.querySelector('#teacher_name').value;


                        var subPage = "";
                        if (studnetName) {
                            subPage = page.querySelector('#profileform1');
                        }
                        if (teacherName) {
                            subPage = page.querySelector('#profileform2');
                        }

                        var inputs = subPage.querySelectorAll('input');
                        var textareas = subPage.querySelectorAll('textarea');

                        for (var y = 0; y < inputs.length; y++) {
                            if (inputs[y].id) {
                                allinputs.push(inputs[y]);
                            }
                        }
                        for (var y = 0; y < textareas.length; y++) {
                            if (textareas[y].id) {
                                allinputs.push(textareas[y]);
                            }
                        }

                        if (active == "add") {
                            if (studnetName) {
                                createNewStudentData(allinputs);
                            }
                            if (teacherName) {
                                alert("new teachers require an image, classes ect. Send me the info for the teacher");
                            }
                        }
                        if (active == "edit") {
                            if (studnetName) {
                                saveNPCStudentData(allinputs);
                            }
                            if (teacherName) {
                                // alert("new teachers require an image, classes ect. Send me the info for the teacher");
                            }
                        }
                    }
                }
                //Notes
                if (saveloc == "extra notes") {
                    var textareas = page.querySelectorAll('textarea');
                    var allinputs = [];
                    for (var y = 0; y < textareas.length; y++) {
                        if (textareas[y].id) {
                            allinputs.push(textareas[y]);
                        }
                    }
                    saveNotes(allinputs);
                }
            } else {
                alert("Please unselect one of the options - add or edit");
            }
            // Turn button on after 1 second
            setTimeout(function () {
                this.enabled;
            }, 1000);
        }
        if (this.id == "delete") {
            var editbtn = page.querySelector('#edit');
            var addbtn = page.querySelector('#add');

            var studentID = this.parentElement.parentElement.querySelector('#nid').value;
            var teacherID = this.parentElement.parentElement.querySelector('#tid').value;
            if (studentID) {
                deleteStudent(studentID);
            }
            if (teacherID) {
                alert("Please let me know that you want to remove teacher: " + teacherID);
            }
        }
    })

    ////// Setters
    function saveWage() {
        var sid = document.getElementById('profile').querySelector('#pid').value;
        var newWage = this.value;
        _supabase.from('Job<>Student').update({ 'wage': newWage }).eq('Student', sid).then(response => {
        })
    }    

    // Removers
    function fireFromJob() {
        var sid = document.getElementById('profile').querySelector('#profileform1').querySelector('#pid').value;
        _supabase.from('Job<>Student').delete().eq('Student', sid).then(response => {
        })
        var parent = this.parentNode;
        parent.style.display = "none";
    }
    function kickFromClub() {
        var sid = document.getElementById('profile').querySelector('#profileform1').querySelector('#pid').value;
        var cid = this.id;
        _supabase.from('Club<>Student').delete().eq('club', cid).eq('student', sid).then(response => {
            var parent = this.parentNode;
            parent.style.display = "none";
        })
    }
</script>