<!Document>
<head>
    <link rel="stylesheet" type="text/css" href="/styles/imports.css">
    <link rel="stylesheet" type="text/css" href="/views/layout.css">
    <link rel="stylesheet" type="text/css" href="/views/nav.css">

    <link rel="stylesheet" type="text/css" href="/views/studentView/studentView.css">

    <title>Student</title>
    <link rel="icon" href="/assets/strix_logo.png">
</head>
<html>
<body>
    <!-- Header -->
    <div data-include="header"></div>

    <!-- Navigation -->
    <div data-include="navigation"></div>

    <!-- BG -->
    <div id="bg1"></div>
    <div id="particleGenerator"></div>

    <!-- Main -->
    <main>
        <div class="leftnav">
            <div class="block">
                <a href="about.html">
                    <img id="collegeLogo" src="assets/strix_logo.png" />
                </a>
            </div>
            <div id="subnavchoices" class="choices">
                <p class="choice selected">Profile</p>
                <p class="choice">Details</p>
                <p class="choice">Courses</p>
                <p class="choice">Exams</p>
                <p class="choice">Relationships</p>
                <p class="choice">Job and Extras</p>
                <p class="choice" hidden>Coming Soon</p>
                <p class="choice">Account Details</p>
                <p class="choice">Logout</p>
            </div>
        </div>
        <div id="pages" class="mainpage">
            <div class="page" id="profile">
                <div class="controls">
                    <button id="edit" class="control fa fa-pencil-square-o"></button>
                    <button id="save" class="control fa fa-floppy-o"></button>
                </div>
                <h2>Profile</h2>
                <div class="mainbody">
                    <div class="top">
                        <div class="card">
                            <img id="profilepicture" />
                        </div>
                        <form id="profileform1">
                            <label>Name: <input id="name" placeholder="Name" disabled /></label>
                            <label>Age: <input id="age" placeholder="Age" disabled /></label>
                            <label>Gender: <input id="gender" placeholder="Gender" disabled /></label>
                            <label>Race: <input id="race" placeholder="Race" disabled /></label>
                            <label>Subrace: <input id="subrace" placeholder="Subrace" disabled /></label>
                            <label>Class: <input id="class" placeholder="Class" disabled /></label>
                            <label>Subclass: <input id="subclass" placeholder="Subclass" disabled /></label>
                            <label>Level: <input id="level" placeholder="Level" disabled /></label>
                        </form>
                        <form id="profileform2">
                            <label>Alignment: <input id="alignment" placeholder="Alignment" disabled /></label>
                            <label>Height: <input id="height" placeholder="Height" disabled /></label>
                            <label>Weight: <input id="weight" placeholder="Weight" disabled /></label>
                            <label>Hair Colour: <input id="haircolour" placeholder="Hair Colour" disabled /></label>
                            <label>Eye Colour: <input id="eyecolour" placeholder="Eye Colour" disabled /></label>
                            <label>Background: <input id="background" placeholder="Background" disabled /></label>
                            <label>Year: <input id="year" placeholder="Year" disabled /></label>
                            <label>College: 
                                <select id="college" disabled>
                                    <option value="0">-- Please Select College Choice --</option>
                                </select>
                            </label>
                        </form>
                    </div>
                    <div class="bottom">
                        <div class="personality scrollbar">
                            <div class="personal">
                                <p>Personality Traits:</p>
                                <textarea id="personalitytraits" class="scrollbar" placeholder="Personality Traits" readonly></textarea>
                            </div>
                            <div class="personal">
                                <p>Ideals:</p>
                                <textarea id="ideals" class="scrollbar" placeholder="Ideals" readonly></textarea>
                            </div>
                            <div class="personal">
                                <p>Bonds:</p>
                                <textarea id="bonds" class="scrollbar" placeholder="Bonds" readonly></textarea>
                            </div>
                            <div class="personal">
                                <p>Flaws:</p>
                                <textarea id="flaws" class="scrollbar" placeholder="Flaws" readonly></textarea>
                            </div>
                            <div class="personal">
                                <p>Goals:</p>
                                <textarea id="goals" class="scrollbar" placeholder="Your life time desire" readonly></textarea>
                            </div>
                        </div>
                        <div class="right">
                            <div class="formfield">
                                <label>Background Features:</label>
                                <textarea id="backgroundfeatures" class="scrollbar" placeholder="Background Features" readonly></textarea>
                            </div>
                            <div class="formfield">
                                <label>Additional Character Appearance:</label>
                                <textarea id="appearance" class="scrollbar" placeholder="Additional Character Appearance" readonly></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="page" id="details" hidden>
                <div class="controls">
                    <button id="edit" class="control fa fa-pencil-square-o"></button>
                    <button id="save" class="control fa fa-floppy-o"></button>
                </div>
                <h2>Details</h2>
                <div class="splitbody">
                    <div class="split">
                        <p>Backstory:</p>
                        <textarea id="backstory" class="scrollbar" placeholder="Backstory" readonly></textarea>
                    </div>
                    <div class="split">
                        <p>Extras:</p>
                        <textarea id="extranotes" class="scrollbar" placeholder="Extra notes" readonly></textarea>
                    </div>
                </div>
            </div>

            <div class="page" id="courses" hidden>
                <h2>Courses</h2>
                <div class="top">
                    <div class="year">
                        <div class="controls">
                            <button id="save" class="control fa fa-floppy-o"></button>
                        </div>
                        <h3>Yr 1</h3>
                        <div class="coursechoices">
                            <div id="Y1S1" class="coursechoice">
                                <select>
                                    <option>-- Select Course --</option>
                                </select>
                                <p></p>
                            </div>
                            <div id="Y1S2" class="coursechoice">
                                <select>
                                    <option>-- Select Course --</option>
                                </select>
                                <p></p>
                            </div>
                            <div id="Y1S3" class="coursechoice">
                                <select>
                                    <option>-- Select Course --</option>
                                </select>
                                <p></p>
                            </div>
                            <div id="Y1S4" class="coursechoice">
                                <select>
                                    <option>-- Select Course --</option>
                                </select>
                                <p></p>
                            </div>
                        </div>
                    </div>
                    <div class="year">
                        <div class="controls">
                            <button id="save" class="control fa fa-floppy-o"></button>
                        </div>
                        <h3>Yr 2</h3>
                        <div class="coursechoices">
                            <div id="Y2S1" class="coursechoice">
                                <select>
                                    <option>-- Select Course --</option>
                                </select>
                                <p></p>
                            </div>
                            <div id="Y2S2" class="coursechoice">
                                <select>
                                    <option>-- Select Course --</option>
                                </select>
                                <p></p>
                            </div>
                            <div id="Y2S3" class="coursechoice">
                                <select>
                                    <option>-- Select Course --</option>
                                </select>
                                <p></p>
                            </div>
                            <div id="Y2S4" class="coursechoice">
                                <select>
                                    <option>-- Select Course --</option>
                                </select>
                                <p></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bottom">
                    <div class="year">
                        <div class="controls">
                            <button id="save" class="control fa fa-floppy-o"></button>
                        </div>
                        <h3>Yr 3</h3>
                        <div class="coursechoices">
                            <div id="Y3S1" class="coursechoice">
                                <select>
                                    <option>-- Select Course --</option>
                                </select>
                                <p></p>
                            </div>
                            <div id="Y3S2" class="coursechoice">
                                <select>
                                    <option>-- Select Course --</option>
                                </select>
                                <p></p>
                            </div>
                            <div id="Y3S3" class="coursechoice">
                                <select>
                                    <option>-- Select Course --</option>
                                </select>
                                <p></p>
                            </div>
                            <div id="Y3S4" class="coursechoice">
                                <select>
                                    <option>-- Select Course --</option>
                                </select>
                                <p></p>
                            </div>
                        </div>
                    </div>
                    <div class="year">
                        <div class="controls">
                            <button id="save" class="control fa fa-floppy-o"></button>
                        </div>
                        <h3>Yr 4</h3>
                        <div class="coursechoices">
                            <div id="Y4S1" class="coursechoice">
                                <select>
                                    <option>-- Select Course --</option>
                                </select>
                                <p></p>
                            </div>
                            <div id="Y4S2" class="coursechoice">
                                <select>
                                    <option>-- Select Course --</option>
                                </select>
                                <p></p>
                            </div>
                            <div id="Y4S3" class="coursechoice">
                                <select>
                                    <option>-- Select Course --</option>
                                </select>
                                <p></p>
                            </div>
                            <div id="Y4S4" class="coursechoice">
                                <select>
                                    <option>-- Select Course --</option>
                                </select>
                                <p></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="page" id="exams" hidden>
                <h2>Exams and Results</h2>
                <div class="top">
                    <div class="year">
                        <h3>Yr 1</h3>
                        <div class="exams">
                            
                        </div>
                    </div>
                    <div class="year">
                        <h3>Yr 2</h3>
                        <div class="exams">

                        </div>
                    </div>
                </div>
                <div class="bottom">
                    <div class="year">
                        <h3>Yr 3</h3>
                        <div class="exams">

                        </div>
                    </div>
                    <div class="year">
                        <h3>Yr 4</h3>
                        <div class="exams">

                        </div>
                    </div>
                </div>
            </div>

            <div class="page" id="relationships" hidden>
                <h2>Relationships</h2>
                <p id="insporation"></p>
                <div class="cubeWrapper">
                    <div id="cubes">
                    </div>
                </div>
            </div>

            <div class="page" id="jobandextra" hidden>
                <h2>Job</h2>
                <div id="jobs">
                </div>
                <h2>Extracurriculars</h2>
                <div id="clubs">
                </div>
            </div>

            <div class="page" id="account" hidden>
                <h2>Account Details</h2>
                <form id="newPas">
                    <label for="CPW">Current Password</label>
                    <input id="CPW" placeholder="Current Password" type="password" />
                    <label for="NPW">New Password</label>
                    <input id="NPW" placeholder="New Password" type="password" />
                    <label for="CNPW">Confirm Password</label>
                    <input id="CNPW" placeholder="Confirm Password" type="password" />
                    <br />
                    <button id="newpas" type="button">Submit</button>
                </form>
                <button id="deleteUser">Clear Profile</button>
                <div class="clearConfirm" hidden>
                    <div class="subConfirm">
                        <h2>This will clear all data about your character, are you sure?</h2>
                        <button>Yes</button>
                        <button>No</button>
                    </div>
                </div>
            </div>
        </div>
    </main>
</body>
</html>

<script src="https://code.jquery.com/jquery-3.6.1.js"></script>
<script src="/javascript/nav.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<script>
    var pageid = 'Loading';
    $(function () {
        var includes = $('[data-include]')
        $.each(includes, function () {
            var file = 'views/addons/_' + $(this).data('include') + '.html'
            $(this).load(file)
        })
    })
    function loadPage() {
        // Load last page saved on
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        const toOpen = urlParams.get('page');
        if (toOpen) {
            var allPages = document.getElementById('pages').querySelectorAll(".page");
            var allChoices = document.getElementById('subnavchoices').querySelectorAll(".choice");
            for (var x = 0; x < allPages.length; x++) {
                allPages[x].setAttribute("hidden", "true");
            }
            for (var x = 0; x < allChoices.length; x++) {
                allChoices[x].classList = "choice";
                if (allChoices[x].innerText.toLowerCase() == toOpen) {
                    allChoices[x].classList = "choice selected";
                }
            }
            // Check the data has been loaded for the page

            // profile - Done on load
            // details - Done on load
            // courses
            if (toOpen == "courses") {
                getStudentCourseByID(sessionStorage.getItem("Student_Id"));
            }
            // exams - Nothing to save
            // relationships - Nothing to save
            // job and extras - Nothing to save

            // Reset URL
            window.history.pushState("object or string", "Title", "/studentview.html");

            // Show Page
            document.getElementById(toOpen).toggleAttribute("hidden");
        }
    }

    // Non Data Base
    $('.choice').click(function () {
        clearpages();
        var sidenav = document.getElementById('subnavchoices');
        var choices = sidenav.querySelectorAll('p');
        for (var x = 0; x < choices.length; x++) {
            choices[x].classList = "choice";
        }
        this.classList = "choice selected";

        var mainpage = document.getElementById('pages');
        var pages = mainpage.querySelectorAll('.page');
        for (var x = 0; x < pages.length; x++) {
            if (pages[x]) {
                pages[x].setAttribute("hidden", "true");
            }
        }
        var toshow = this.innerText.toLowerCase();
        if (toshow == "job and extras") {
            toshow = "jobandextra";
        }
        if (toshow == "account details") {
            toshow = "account";
        }
        if (toshow == "logout") {
            logot();
            toshow = "profile";
        }
        if (toshow == "courses") {
            getStudentCourseByID(sessionStorage.getItem("Student_Id"));
        }
        if (toshow == "exams") {
            getStudentExamByID(sessionStorage.getItem("Student_Id"));
        }
        if (toshow == "relationships") {
            getRelationships(sessionStorage.getItem("Student_Id"));
        }
        document.getElementById(toshow).toggleAttribute("hidden");
    })
    $('.control').click(function () {
        if (this.id == "edit") {
            if (this.classList != "fa fa-pencil-square-o activecontrol") {
                this.classList = "fa fa-pencil-square-o activecontrol";
                togglecurrent();
            } else {
                this.classList = "control fa fa-pencil-square-o";
                togglecurrent();
            }
        }
        if (this.id == "save") {
            this.disabled;
            var mainpage = document.getElementById('pages');
            var pages = mainpage.querySelectorAll('.page');
            for (var x = 0; x < pages.length; x++) {
                if (pages[x]) {
                    if (pages[x].id == "courses") {
                        var courses = [];
                        var year = this.parentNode.parentNode;
                        var selects = year.querySelectorAll('select');
                        for (var y = 0; y < selects.length; y++) {
                            var select = selects[y];
                            var options = select.querySelectorAll('option');
                            for (var z = 0; z < options.length; z++) {
                                var option = options[z];
                                if (option.selected) {
                                    if (option.value.includes(":")) {
                                        var selected = option.value;
                                        var split = selected.split(":");
                                        courses.push(split[0]);
                                    }
                                }
                            }
                        }
                        if (courses.length > 0) {
                            saveCourseChoices(courses);
                        }
                    } else {
                        if (window.getComputedStyle(pages[x]).display != "none") {
                            var editbtn = pages[x].querySelector('#edit');
                            if (editbtn.classList != "control fa fa-pencil-square-o") {
                                togglecurrent();
                                editbtn.classList = "control fa fa-pencil-square-o";
                            }
                            var inputs = pages[x].querySelectorAll('input');
                            var textareas = pages[x].querySelectorAll('textarea');
                            var selects = pages[x].querySelectorAll('select');
                            var allinputs = [];
                            for (var y = 0; y < inputs.length; y++) {
                                if (inputs[y].id) {
                                    allinputs.push(inputs[y]);
                                }
                            }
                            for (var y = 0; y < textareas.length; y++) {
                                if (textareas[y].id) {
                                    allinputs.push(textareas[y]);
                                }
                            }
                            for (var y = 0; y < selects.length; y++) {
                                if (selects[y].id) {
                                    if (selects[y].id == "college") {
                                        if (selects[y].value != 0) {
                                            allinputs.push(selects[y]);
                                        }
                                    }
                                }
                            }
                            if (pages[x].id == "profile") {
                                saveStudentProfileData(allinputs);
                            }
                            if (pages[x].id == "details") {
                                saveStudentDetailsData(allinputs);
                            }
                        }
                    }
                }
            }
            setTimeout(function () {
                this.enabled;
            }, 1000);
        }
    })

    $('#newpas').click(function () {
        setNewPass();
    })

    $('#deleteUser').click(function () {
        var doc = this.parentElement.querySelector('.clearConfirm');
        doc.toggleAttribute("hidden");
    })

    $('.subConfirm button').click(function () {
        if (this.innerText == "No") {
            this.parentElement.parentElement.setAttribute("hidden", "true");
        }
        if (this.innerText == "Yes") {
            clearStudentDataById(sessionStorage.getItem("Student_Id"));
        }
    })

    function togglecurrent() {
        var mainpage = document.getElementById('pages');
        var pages = mainpage.querySelectorAll('.page');
        for (var x = 0; x < pages.length; x++) {
            if (pages[x]) {
                if (window.getComputedStyle(pages[x]).display != "none") {
                    var inputs = pages[x].querySelectorAll('input');
                    var textareas = pages[x].querySelectorAll('textarea');
                    for (var y = 0; y < inputs.length; y++) {
                        inputs[y].toggleAttribute("disabled");
                    }
                    for (var y = 0; y < textareas.length; y++) {
                        textareas[y].toggleAttribute("readonly");
                    }
                }
            }
        }
    }
    function toshow(id) {
        var send = 0;
        if (id == "one") {
            send = 0;
        }
        if (id == "two") {
            send = 1;
        }
        if (id == "three") {
            send = 2;
        }
        if (id == "four") {
            send = 3;
        }
        return send;
    }

    $('#Y1S1 select').change(function () {
        setTeacherName('#Y1S1');
    });
    $('#Y1S2 select').change(function () {
        setTeacherName('#Y1S2');
    });
    $('#Y1S3 select').change(function () {
        setTeacherName('#Y1S3');
    });
    $('#Y1S4 select').change(function () {
        setTeacherName('#Y1S4');
    });
    $('#Y2S1 select').change(function () {
        setTeacherName('#Y2S1');
    });
    $('#Y2S2 select').change(function () {
        setTeacherName('#Y2S2');
    });
    $('#Y2S3 select').change(function () {
        setTeacherName('#Y2S3');
    });
    $('#Y2S4 select').change(function () {
        setTeacherName('#Y2S4');
    });
    $('#Y3S1 select').change(function () {
        setTeacherName('#Y3S1');
    });
    $('#Y3S2 select').change(function () {
        setTeacherName('#Y3S2');
    });
    $('#Y3S3 select').change(function () {
        setTeacherName('#Y3S3');
    });
    $('#Y3S4 select').change(function () {
        setTeacherName('#Y3S4');
    });
    $('#Y4S1 select').change(function () {
        setTeacherName('#Y4S1');
    });
    $('#Y4S2 select').change(function () {
        setTeacherName('#Y4S2');
    });
    $('#Y4S3 select').change(function () {
        setTeacherName('#Y4S3');
    });
    $('#Y4S4 select').change(function () {
        setTeacherName('#Y4S4');
    });

    function setTeacherName(selector) {
        var select = $(selector + ' select');
        var selectedoption = select.find(":selected")[0];
        var selectedValue = selectedoption.value;
        var split = selectedValue.split(':');

        var newTeacher = document.createElement('span');
        newTeacher.innerText = "Teacher: ";

        $(selector + ' p span').remove();
        $(selector + ' p').text("");

        $(selector + ' p').append(newTeacher);
        $(selector + ' p').append(split[1]);

        var selected = $(selector + ' select').val();

        $("select option").each(function () {
            $(this).show();
        });

        $("select option[value='" + selected + "']").each(function () {
            if (this.parentElement.value != selected) {
                $(this).hide();
            }
        });
    }

    function getAllInputs(toClear) {
        var inputs = toClear.querySelectorAll('input');
        var textareas = toClear.querySelectorAll('textarea');
        var selects = toClear.querySelectorAll('select');
        var allinputs = [];
        for (var y = 0; y < inputs.length; y++) {
            if (inputs[y].id) {
                allinputs.push(inputs[y]);
            }
        }
        for (var y = 0; y < textareas.length; y++) {
            if (textareas[y].id) {
                allinputs.push(textareas[y]);
            }
        }
        for (var y = 0; y < selects.length; y++) {
            if (selects[y].id) {
                if (selects[y].id == "college") {
                    if (selects[y].value != 0) {
                        allinputs.push(selects[y]);
                    }
                }
            }
        }
        return allinputs;
    }

    function reloadPage() {
        var allPages = document.getElementById('pages').querySelectorAll(".page");

        for (var x = 0; x < allPages.length; x++) {
            if (allPages[x].checkVisibility()) {
                var currentPage = allPages[x].id;
                const urlParams = new URLSearchParams(window.location.search);
                urlParams.set('page', currentPage);
                window.location.search = urlParams;
            }
        }
    }

    function clearpages() {
        // course selectors and teachers
        var page = document.getElementById('courses');
        var selects = page.querySelectorAll('select');
        var ps = page.querySelectorAll('p');
        for (var x = 0; x < selects.length; x++) {
            if (selects[x].value == 0) {
                selects[x].value = 0;
            }
            ps[x].innerHTML = "";
        }

    }
</script>
<script src="../../API/api.js"></script>
<script src="/javascript/login.js"></script>
<script>
    $(document).ready(async function () {
        var sid = JSON.parse(sessionStorage.getItem("Student_Id"));
        if (sid) {
            getCollegeDropdownData();
            getCourseData();
            await getStudentData(sid);            
            loadPage();
        }
    })

    // Getters
    function getCollegeDropdownData() {
        _supabase.from('_tblColleges').select('*').order('id', { ascending: false }).then(response => {
            for (var y = 0; y < response.data.length; y++) {
                var col = response.data[y];
                var newCollege = document.createElement('option');
                newCollege.value = col['id'];
                newCollege.innerText = col['college_name'];
                profile.querySelector('#college').appendChild(newCollege);
            }
        })
    }
    function getCourseData() {
        _supabase.from('class<>teacher').select('class(id, name, year, required), teacher(id, teacher_name)').then(response => {
            var data = response.data;
            for (var x = 0; x < data.length; x++) {
                var course = data[x]['class'];
                var teacher = data[x]['teacher'];
                if (course['year'] == 1) {
                    $('#Y1S1 select').append($('<option>', {
                        value: course['id'] + ":" + teacher['teacher_name'],
                        text: course['name']
                    }))
                    $('#Y1S2 select').append($('<option>', {
                        value: course['id'] + ":" + teacher['teacher_name'],
                        text: course['name']
                    }))
                    $('#Y1S3 select').append($('<option>', {
                        value: course['id'] + ":" + teacher['teacher_name'],
                        text: course['name']
                    }))
                    $('#Y1S4 select').append($('<option>', {
                        value: course['id'] + ":" + teacher['teacher_name'],
                        text: course['name']
                    }))
                    if (course['required'] == "yes") {
                        $('#Y1S1 select').val(course['id'] + ":" + teacher['teacher_name']);
                        $('#Y1S1 select').attr("disabled", "true");

                        var newTeacher = document.createElement('span');
                        newTeacher.innerText = "Teacher: ";
                        $('#Y1S1 p').append(newTeacher);
                        $('#Y1S1 p').append(teacher['teacher_name']);
                    }
                }
                if (course['year'] == 2) {
                    $('#Y2S1 select').append($('<option>', {
                        value: course['id'] + ":" + teacher['teacher_name'],
                        text: course['name']
                    }))
                    $('#Y2S2 select').append($('<option>', {
                        value: course['id'] + ":" + teacher['teacher_name'],
                        text: course['name']
                    }))
                    $('#Y2S3 select').append($('<option>', {
                        value: course['id'] + ":" + teacher['teacher_name'],
                        text: course['name']
                    }))
                    $('#Y2S4 select').append($('<option>', {
                        value: course['id'] + ":" + teacher['teacher_name'],
                        text: course['name']
                    }))
                    if (course['required'] == "yes") {
                        $('#Y2S1 select').val(course['id'] + ":" + teacher['teacher_name']);
                        $('#Y2S1 select').attr("disabled", "true");
                        $('#Y2S1 p').text("Teacher: " + teacher['teacher_name']);
                    }
                }
                if (course['year'] == 3) {
                    $('#Y3S1 select').append($('<option>', {
                        value: course['id'] + ":" + teacher['teacher_name'],
                        text: course['name']
                    }))
                    $('#Y3S2 select').append($('<option>', {
                        value: course['id'] + ":" + teacher['teacher_name'],
                        text: course['name']
                    }))
                    $('#Y3S3 select').append($('<option>', {
                        value: course['id'] + ":" + teacher['teacher_name'],
                        text: course['name']
                    }))
                    $('#Y3S4 select').append($('<option>', {
                        value: course['id'] + ":" + teacher['teacher_name'],
                        text: course['name']
                    }))
                    if (course['required'] == "yes") {
                        $('#Y3S1 select').val(course['id'] + ":" + teacher['teacher_name']);
                        $('#Y3S1 select').attr("disabled", "true");
                        $('#Y3S1 p').text("Teacher: " + teacher['teacher_name']);
                    }
                }
                if (course['year'] == 4) {
                    $('#Y4S1 select').append($('<option>', {
                        value: course['id'] + ":" + teacher['teacher_name'],
                        text: course['name']
                    }))
                    $('#Y4S2 select').append($('<option>', {
                        value: course['id'] + ":" + teacher['teacher_name'],
                        text: course['name']
                    }))
                    $('#Y4S3 select').append($('<option>', {
                        value: course['id'] + ":" + teacher['teacher_name'],
                        text: course['name']
                    }))
                    $('#Y4S4 select').append($('<option>', {
                        value: course['id'] + ":" + teacher['teacher_name'],
                        text: course['name']
                    }))
                    if (course['required'] == "yes") {
                        $('#Y4S1 select').val(course['id'] + ":" + teacher['teacher_name']);
                        $('#Y4S1 select').attr("disabled", "true");
                        $('#Y4S1 p').text("Teacher: " + teacher['teacher_name']);
                    }
                }
            }
        });
    }

    async function getStudentData(sid) {
        //// Profile ////
        var studentData = await getStudentByID(sid);
        // Assign Profile Data
        var profile = document.getElementById('profile');
        profile.querySelector('#profilepicture').src = "assets/students/players/" + studentData.picture;
        profile.querySelector('#name').value = studentData.name;
        profile.querySelector('#age').value = studentData.age;
        profile.querySelector('#gender').value = studentData.gender;
        profile.querySelector('#race').value = studentData.race;
        profile.querySelector('#subrace').value = studentData.subrace;
        profile.querySelector('#alignment').value = studentData.alignment;
        profile.querySelector('#haircolour').value = studentData.haircolour;
        profile.querySelector('#eyecolour').value = studentData.eyecolour;
        profile.querySelector('#year').value = studentData.year;
        profile.querySelector('#height').value = studentData.height;
        profile.querySelector('#weight').value = studentData.weight;
        profile.querySelector('#level').value = studentData.level;
        profile.querySelector('#class').value = studentData.class;
        profile.querySelector('#subclass').value = studentData.subclass;
        profile.querySelector('#background').value = studentData.background;
        profile.querySelector('#college').value = studentData.college;
        profile.querySelector('#personalitytraits').value = studentData.personalitytraits;
        profile.querySelector('#personalitytraits').style.height = profile.querySelector('#personalitytraits').scrollHeight + 'px';
        profile.querySelector('#ideals').value = studentData.ideals;
        profile.querySelector('#ideals').style.height = profile.querySelector('#ideals').scrollHeight + 'px';
        profile.querySelector('#bonds').value = studentData.bonds;
        profile.querySelector('#bonds').style.height = profile.querySelector('#bonds').scrollHeight + 'px';
        profile.querySelector('#flaws').value = studentData.flaws;
        profile.querySelector('#flaws').style.height = profile.querySelector('#flaws').scrollHeight + 'px';
        profile.querySelector('#goals').value = studentData.goals;
        profile.querySelector('#goals').style.height = profile.querySelector('#goals').scrollHeight + 'px';
        profile.querySelector('#backgroundfeatures').value = studentData.backgroundfeatures;
        profile.querySelector('#backgroundfeatures').style.height = profile.querySelector('#backgroundfeatures').scrollHeight + 'px';
        profile.querySelector('#appearance').value = studentData.appearance;
        profile.querySelector('#appearance').style.height = profile.querySelector('#appearance').scrollHeight + 'px';
        // Page Changes //
        // Page Title
        var headertitle = await document.getElementById('pagename');
        if (studentData.name) {
            headertitle.innerText = "Welcome " + studentData.name;
        } else {
            headertitle.innerText = "Welcome " + studentData.player;
        }
        // College Logo
        var cLogo = await document.getElementById('collegeLogo');
        if (studentData.college == 6) {
            cLogo.src = "assets/strix_logo.png";
        }
        if (studentData.college == 5) {
            cLogo.src = "assets/maps/witherbloom.png";
        }
        if (studentData.college == 4) {
            cLogo.src = "assets/maps/silverquill.png";
        }
        if (studentData.college == 3) {
            cLogo.src = "assets/maps/quandrix.png";
        }
        if (studentData.college == 2) {
            cLogo.src = "assets/maps/prismari.png";
        }
        if (studentData.college == 1) {
            cLogo.src = "assets/maps/lorehold.png";
        }
        // Check for college year and college Enrolled
        if (studentData.year > 1) {
            if (studentData.college == 6) {
                profile.querySelector('#college').toggleAttribute("disabled");
                profile.querySelector('#college').style.border = "2px white solid";
                profile.querySelector('#college').value = 0;
            }
        }
        //// Details ////
        // Assign Details Data
        var details = document.getElementById('details');
        details.querySelector('#backstory').value = studentData.backstory;
        details.querySelector('#extranotes').value = studentData.extranotes;
        //// Job ////
        var studentJob = await getStudentJobByStudentID(sid);
        if (studentJob) {
            // Assign Job Data
            var currentJob = document.getElementById('jobs');
            const theJob = document.createElement('div');
            const theTitle = document.createElement('h3');
            const theLocation = document.createElement('p');
            const theWage = document.createElement('p');
            const theCoworker = document.createElement('p');
            const QuitButton = document.createElement('button');
            theJob.classList = "job";
            theJob.id = "job";
            QuitButton.classList = "quit";
            QuitButton.id = studentJob.id;
            QuitButton.innerText = "Resign";
            QuitButton.addEventListener('click', quitJob, false);
            theTitle.innerText = studentJob.Job.Title;
            theLocation.innerText = studentJob.Job.Location;
            theLocation.classList = "location";
            theWage.innerText = studentJob.wage;
            theWage.classList = "wage";
            var coworkers = await getJobCoworkers(studentJob.Job.id);
            var theCoworkers = "";
            var wcount = 0;
            for (var x = 0; x < coworkers.length; x++) {
                var worker = coworkers[x]['Student'];
                if (sessionStorage.getItem('Student_Id') != worker.id) {
                    if (worker.name) {
                        if (wcount > 0) {
                            theCoworkers = theCoworkers + " & " + worker.name;
                        } else {
                            theCoworkers = worker.name;
                        }
                        wcount++;
                    }
                }
            }
            theCoworker.innerText = theCoworkers;
            theCoworker.classList = "coworker";
            theJob.appendChild(theTitle);
            theJob.appendChild(theLocation);
            theJob.appendChild(theCoworker);
            theJob.appendChild(theWage);
            theJob.appendChild(QuitButton);
            currentJob.appendChild(theJob);
        }
        //// Clubs ////
        var clubs = await getClubByStudentID(sid);
        if (clubs) {
            var clubList = document.getElementById('clubs');
            for (var x = 0; x < clubs.length; x++) {
                var club = clubs[x].club;
                const theClub = document.createElement('div');
                const theClubName = document.createElement('p');
                const theClubSkill = document.createElement('p');
                const theClubDice = document.createElement('p');
                const theClubMembers = document.createElement('div');
                const theClubQuit = document.createElement('button');
                theClub.classList = "club";
                theClubName.classList = "clubname";
                theClubName.innerText = club.name;
                theClubSkill.classList = "clubskill";
                theClubSkill.innerText = club.skills;
                theClubDice.classList = "dice";
                theClubDice.innerText = "1d4";
                theClubMembers.classList = "members scrollbar";
                var clubMembers = await getClubMembersByClubID(club.id);
                for (var y = 0; y < clubMembers.length; y++) {
                    if (sessionStorage.getItem("Student_Id") != clubMembers[y].student.id) {
                        const theClubMember = document.createElement('p');
                        theClubMember.classList = "member";
                        theClubMember.innerText = clubMembers[y].student.name;
                        theClubMembers.appendChild(theClubMember);
                    }
                }
                theClubQuit.classList = "quit";
                theClubQuit.innerText = "Quit Club";
                theClubQuit.id = club.id;
                theClubQuit.addEventListener('click', quitClub, false);
                theClub.appendChild(theClubName);
                theClub.appendChild(theClubSkill);
                theClub.appendChild(theClubDice);
                theClub.appendChild(theClubMembers);
                theClub.appendChild(theClubQuit);
                clubList.appendChild(theClub);
            }
        }
    }

    function getRelationships(sid) {
        _supabase.from('npc<>student').select('npc(id, name, year, bane, boon), student, relationship').eq('student', sid).order('npc', { ascending: true }).then(response => {
            var relationshipPage = document.getElementById('relationships');
            var page = relationshipPage.querySelector('#cubes');
            var lovers = 0;
            page.innerHTML = "";
            for (var x = 0; x < response.data.length; x++) {
                var data = response.data[x];
                const newCube = document.createElement("div");
                const newName = document.createElement("p");

                const newRelationship = document.createElement("div");
                const newBoon = document.createElement("div");
                const newBane = document.createElement("div");

                const newScoreSpan = document.createElement("span");
                const newRelationshipSpan = document.createElement("span");
                const newBoonSpan = document.createElement("span");
                const newBaneSpan = document.createElement("span");

                newName.innerText = data['npc']['name'];

                var text = "";
                if (data['relationship'] >= "-100") {
                    if (data['relationship'] >= 8) {
                        text = "Lover";
                        lovers++;
                    } else if (data['relationship'] >= "3") {
                        text = "Friend";
                    } else if (data['relationship'] >= "0") {
                        text = "Neutral";
                    } else {
                        text = "Rival";
                    }
                }
                newRelationshipSpan.innerText = "Relationship: ";
                newRelationship.appendChild(newRelationshipSpan);
                var newTextRelationship = document.createElement('p');
                newTextRelationship.innerText = " " + text;
                newRelationship.appendChild(newTextRelationship);

                newBoonSpan.innerText = "Boon: ";
                newBoon.appendChild(newBoonSpan);
                var newTextBoon = document.createElement('p');
                newTextBoon.innerText = " " + data['npc']['boon'];
                newBoon.appendChild(newTextBoon);

                newCube.classList = "cube";
                newCube.id = data['npc']['id'];

                newName.classList = "cName";

                newCube.appendChild(newName);
                newCube.appendChild(newRelationship);

                if (data['relationship'] >= "-100") {
                    if (data['relationship'] >= "3") {
                        newCube.appendChild(newBoon);
                    }
                }

                page.appendChild(newCube);
            }
            if (lovers > 0) {
                var inspo = relationshipPage.querySelector('#insporation');
                var prof = 0;
                var clevel = document.getElementById('profile').querySelector('#level').value;
                if (clevel <= 20) {
                    prof = 6;
                    if (clevel < 17) {
                        prof = 5;
                        if (clevel < 13) {
                            prof = 4;
                            if (clevel < 9) {
                                prof = 3;
                                if (clevel < 5) {
                                    prof = 2;
                                }
                            }
                        }
                    }
                }
            }
            if (inspo) {
                inspo.innerText = "Inspiration: " + lovers + "/" + prof;
            }
        });
    }    
    function getStudentCourseByID(sid) {
        _supabase.from('class<>student').select('class(id, year, name, required), student(id, name)').eq('student', sid).order('class', { ascending: false }).then(response => {
            var data = response.data;
            var Y1C = 1;
            var Y2C = 1;
            var Y3C = 1;
            var Y4C = 1;

            for (var x = 0; x < data.length; x++) {
                var course = data[x]['class'];
                var student = data[x]['student'];

                // Create location of course option
                if (course['year'] == 1) {
                    var classChoice = "Y1S" + Y1C;
                    Y1C++;
                }
                if (course['year'] == 2) {
                    var classChoice = "Y2S" + Y2C;
                    Y2C++;
                }
                if (course['year'] == 3) {
                    var classChoice = "Y3S" + Y3C;
                    Y3C++;
                }
                if (course['year'] == 4) {
                    var classChoice = "Y4S" + Y4C;
                    Y4C++;
                }

                // Select course option and lock dropdown
                $('#' + classChoice + ' select > option').each(function () {
                    var split = $(this).val().split(":");
                    var courseId = split[0];
                    var teacher = split[1];
                    if (courseId == course['id']) {
                        $('#' + classChoice + ' select').val(course['id'] + ":" + teacher).change();
                        $('#' + classChoice + ' select').attr("disabled", "true");                        

                        // Remove for other dropdowns
                        var selected = this.value;
                        $("select option[value='" + selected + "']").each(function () {
                            if (this.parentElement.value != selected) {
                                $(this).remove();
                            }                             
                        });
                    }
                });
            }
            // Courses
            var theyear = document.getElementById('profile').querySelector('#year').value;
            if (theyear) {
                var coursesPage = document.getElementById('courses');
                var courseYears = coursesPage.querySelectorAll('.year');
                for (var y = 0; y < courseYears.length; y++) {
                    var year = courseYears[y];
                    var saveBtn = year.querySelector('.controls');
                    if (y <= theyear - 1) {
                        var coursesSelected = year.querySelectorAll('select');
                        var number = 0;
                        for (var z = 0; z < coursesSelected.length; z++) {
                            if (coursesSelected[z].disabled) {
                                number++;
                            }
                        }
                        if (number == 4) {
                            saveBtn.style.display = "none";
                        }
                    } else {
                        year.querySelector('.coursechoices').innerHTML = "";
                        saveBtn.style.display = "none";
                    }
                }
            }
        });
    }
    function getStudentExamByID(sid) {
        var examsPage = document.getElementById('exams');
        var examExams = examsPage.querySelectorAll('.exams');

        for (var y = 0; y < examExams.length; y++) {
            examExams[y].innerHTML = "";
        }
        _supabase.from('exam<>student').select('exam(*), score, studied, cheated, student(year)').eq('student', sid).order('exam', { ascending: true }).then(response => {
            var exams = response.data;
            for (var x = 0; x < exams.length; x++) {
                var exam = exams[x];
                for (var y = 0; y < examExams.length; y++) {
                    var newExam = document.createElement("div");
                    var newTitle = document.createElement("p");
                    var newScore = document.createElement("p");
                    var newDice = document.createElement("p");
                    var newSkills = document.createElement("p");

                    if (y + 1 == exam['exam']['year']) {

                        newTitle.innerText = exam['exam']['name'];
                        if (exam['score']) {
                            newScore.innerText = exam['score'];
                            if (exam['score'] == "ace") {
                                newDice.innerText = "2d4";
                            }
                            if (exam['score'] == "pass") {
                                newDice.innerText = "1d4";
                            }
                            if (exam['score'] == "fail") {
                                newDice.innerText = "0d4";
                            }

                            newSkills.innerText = exam['exam']['skill'];

                            newTitle.classList = "etitle"
                            newScore.classList = "escore"
                            newDice.classList = "edice"
                            newSkills.classList = "eskill"

                            newExam.classList = "exam";

                            newExam.appendChild(newTitle);
                            newExam.appendChild(newScore);
                            newExam.appendChild(newDice);
                            newExam.appendChild(newSkills);

                            if (exam['exam']['year'] <= exam['student']['year']) {
                                if (exam['score'] != "null") {
                                    examExams[y].appendChild(newExam);
                                }
                            }
                        }
                    }
                }
            }
        });
    }

    // Setters
    function setNewPass() {
        var Form = document.getElementById('newPas');
        if (Form.querySelector('#NPW').value != "") {
            // Check Confirm Password
            if (Form.querySelector('#NPW').value == Form.querySelector('#CNPW').value) {
                var id = "";
                if (sessionStorage.getItem("Student_Id")) {
                    id = sessionStorage.getItem("Student_Id");
                }
                // Check Current Password is Correct
                _supabase.from('_tblLogin').select('log_use').eq('student_id', id).eq('log_pas', Form.querySelector('#CPW').value).then(response => {
                    if (response.data.length > 0) {
                        // Update Password
                        _supabase.from('_tblLogin').update({ log_pas: Form.querySelector('#NPW').value }).eq('student_id', id).eq('log_pas', Form.querySelector('#CPW').value).then(response => {
                            alert("Your password has been updated");
                            reloadPage();
                        })
                    }
                });
            }
        }
    }
    function saveStudentProfileData(inputs) {
        var updateobject = {};
        var yr = 0;
        for (var x = 0; x < inputs.length; x++) {
            updateobject[inputs[x].id] = inputs[x].value;
            if (inputs[x].id == "year") {
                yr = inputs[x].value;
            }
        }
        if (yr == 1) {
            if (updateobject.college != 6) {
                updateobject.college = 6
            }
        }

        // Validation
        var canUpdate = "no";
        var cleared = 0;
        if (updateobject.year > 0 && updateobject.year < 5) {
            cleared++;
        } else {
            alert("Year must be between 1 and 4");
        }
        if (updateobject.level > 0 && updateobject.level < 21) {
            cleared++;
        } else {
            alert("Level must be between 1 and 20");
        }

        if (cleared == 2) {
            canUpdate = "yes";
        }
        if (canUpdate == "yes") {
            _supabase.from('_tblStudents').update(updateobject).eq('id', sessionStorage.getItem("Student_Id")).then(response => {
                reloadPage();
            })
        }
    }
    function saveStudentDetailsData(inputs) {
        var updateobject = {};
        var yr = 0;
        for (var x = 0; x < inputs.length; x++) {
            updateobject[inputs[x].id] = inputs[x].value;
            if (inputs[x].id == "year") {
                yr = inputs[x].value;
            }
        }
        if (yr == 1) {
            if (updateobject.college != 6) {
                updateobject.college = 6
            }
        }

        _supabase.from('_tblStudents').update(updateobject).eq('id', sessionStorage.getItem("Student_Id")).then(response => {
            reloadPage();
        })
    }
    function saveCourseChoices(choices) {
        _supabase.from('class<>student').select('class(id, year, name, required)').eq('student', sessionStorage.getItem("Student_Id")).then(response => {
            var uniqueCourses = [];
            for (var x = 0; x < response.data.length; x++) {
                var existingCourse = response.data[x]['class'];
                for (var y = 0; y < choices.length; y++) {
                    if (existingCourse['id'] == choices[y]) {
                        delete choices[y];
                    }
                }
            }
            var filtered = choices.filter(function (el) {
                return el != null;
            });
            $.each(filtered, function (i, el) {
                if ($.inArray(el, uniqueCourses) === -1) uniqueCourses.push(el);
            });
            if (uniqueCourses.length > 0) {
                for (var x = 0; x < uniqueCourses.length; x++) {
                    _supabase.from('class<>student').insert({ 'class': uniqueCourses[x], 'student': sessionStorage.getItem("Student_Id") }).then(response => {
                        reloadPage();
                    });
                }
            }
        });
    }

    // Removers
    function quitJob() {
        var sid = JSON.parse(sessionStorage.getItem("Student_Id"));
        _supabase.from('Job<>Student').delete().eq('Student', sid).then(response => {
        })
        alert("You have now resigned");
        var parent = this.parentNode;
        parent.style.display = "none";
        // document.getElementById('myjob').style.display = "none";
    }
    function quitClub() {
        var sid = JSON.parse(sessionStorage.getItem("Student_Id"));
        var cid = this.id;
        _supabase.from('Club<>Student').delete().eq('club', cid).eq('student', sid).then(response => {
            alert("you have left the club");
            var parent = this.parentNode;
            parent.style.display = "none";
        })
    }
    function clearStudentDataById(sid) {
        // Clear Profile
        var toClear = document.getElementById('profile')
        var updateobject = {};
        var inputs = getAllInputs(toClear);
        var numberCleared = 0;

        for (var x = 0; x < inputs.length; x++) {
            updateobject[inputs[x].id] = null;
            if (inputs[x].id == "college") {
                updateobject[inputs[x].id] = 6;
            }
            if (inputs[x].id == "year") {
                updateobject[inputs[x].id] = 1;
            }
        }
        _supabase.from('_tblStudents').update(updateobject).eq('id', sid).then(response => {
            // Clear Details
            var toClear = document.getElementById('details')
            var updateobject = {};
            var inputs = getAllInputs(toClear);
            for (var x = 0; x < inputs.length; x++) {
                updateobject[inputs[x].id] = null;
            }
            _supabase.from('_tblStudents').update(updateobject).eq('id', sid).then(response => {
                // Reset Courses
                _supabase.from('class<>student').delete().eq('student', sid).then(response => {
                    // Reset Exams
                    var updateobject = {};
                    for (var x = 0; x < 11; x++) {
                        updateobject['score'] = null;
                        updateobject['cheated'] = null;
                        updateobject['studied'] = null;
                        _supabase.from('exam<>student').update(updateobject).eq('exam', x).eq('student', sid).then(response => {
                        })
                    }
                    // Clear Relationships
                    _supabase.from('npc<>student').delete().eq('student', sid).then(response => {
                        // Clear Job
                        _supabase.from('Job<>Student').delete().eq('Student', sid).then(response => {
                            // Clear Extras
                            _supabase.from('Club<>Student').delete().eq('student', sid).then(response => {
                                window.location = window.location;
                            })
                        })
                    })
                })
            })
        })
    }
</script>