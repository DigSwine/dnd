<!Document>
<head>
    <link rel="stylesheet" type="text/css" href="/styles/imports.css">
    <link rel="stylesheet" type="text/css" href="/views/layout.css">
    <link rel="stylesheet" type="text/css" href="/views/nav.css">

    <link rel="stylesheet" type="text/css" href="/views/studentView/studentView.css">

    <title>Student</title>
    <link rel="icon" href="/assets/strix_logo.png">

</head>
<html>
<body>
    <!-- Header -->
    <div data-include="header"></div>

    <!-- Navigation -->
    <div data-include="navigation"></div>

    <!-- BG -->
    <div id="bg1"></div>
    <div id="particleGenerator"></div>

    <!-- Main -->
    <main>
        <div class="leftnav">
            <div class="block">
                <a href="about.html">
                    <img src="assets/strix_logo.png" />
                </a>
            </div>
            <div id="subnavchoices" class="choices">
                <p class="choice selected">Profile</p>
                <p class="choice">Details</p>
                <p class="choice">Courses</p>
                <p class="choice">Exams</p>
                <p class="choice">Relationships</p>
                <p class="choice">Job and Extra</p>
                <p class="choice" hidden>Coming Soon</p>
                <p class="choice">Account Details</p>
                <p class="choice">Logout</p>
            </div>
        </div>
        <div id="pages" class="mainpage">
            <div class="page" id="profile">
                <div class="controls">
                    <button id="edit" class="control fa fa-pencil-square-o"></button>
                    <button id="save" class="control fa fa-floppy-o"></button>
                </div>
                <h2>Profile</h2>
                <div class="mainbody">
                    <div class="top">
                        <div class="card">
                            <img id="profilepicture" />
                        </div>
                        <form id="profileform1">
                            <label>Name: <input id="name" placeholder="Name" disabled /></label>
                            <label>Age: <input id="age" placeholder="Age" disabled /></label>
                            <label>Gender: <input id="gender" placeholder="Gender" disabled /></label>
                            <label>Race: <input id="race" placeholder="Race" disabled /></label>
                            <label>Subrace: <input id="subrace" placeholder="Subrace" disabled /></label>
                            <label>Alignment: <input id="alignment" placeholder="Alignment" disabled /></label>
                            <label>Hair Colour: <input id="haircolour" placeholder="Hair Colour" disabled /></label>
                            <label>Eye Colour: <input id="eyecolour" placeholder="Eye Colour" disabled /></label>
                        </form>
                        <form id="profileform2">
                            <label>Height: <input id="height" placeholder="Height" disabled /></label>
                            <label>Weight: <input id="weight" placeholder="Weight" disabled /></label>
                            <label>Level: <input id="level" placeholder="Level" disabled /></label>
                            <label>Class: <input id="class" placeholder="Class" disabled /></label>
                            <label>Subclass: <input id="subclass" placeholder="Subclass" disabled /></label>
                            <label>Background: <input id="background" placeholder="Background" disabled /></label>
                        </form>
                    </div>
                    <div class="bottom">
                        <div class="personality scrollbar">
                            <div class="personal">
                                <p>Personality Traits:</p>
                                <textarea id="personalitytraits" class="scrollbar" placeholder="Personality Traits" readonly></textarea>
                            </div>
                            <div class="personal">
                                <p>Ideals:</p>
                                <textarea id="ideals" class="scrollbar" placeholder="Ideals" readonly></textarea>
                            </div>
                            <div class="personal">
                                <p>Bonds:</p>
                                <textarea id="bonds" class="scrollbar" placeholder="Bonds" readonly></textarea>
                            </div>
                            <div class="personal">
                                <p>Flaws:</p>
                                <textarea id="flaws" class="scrollbar" placeholder="Flaws" readonly></textarea>
                            </div>
                            <div class="personal">
                                <p>Goals:</p>
                                <textarea id="goals" class="scrollbar" placeholder="Your life time desire" readonly></textarea>
                            </div>
                        </div>
                        <div class="right">
                            <div class="formfield">
                                <label>Background Features:</label>
                                <textarea id="backgroundfeatures" class="scrollbar" placeholder="Background Features" readonly></textarea>
                            </div>
                            <div class="formfield">
                                <label>Additional Character Appearance:</label>
                                <textarea id="appearance" class="scrollbar" placeholder="Additional Character Appearance" readonly></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="page" id="details" hidden>
                <div class="controls">
                    <button id="edit" class="control fa fa-pencil-square-o"></button>
                    <button id="save" class="control fa fa-floppy-o"></button>
                </div>
                <h2>Details</h2>
                <div class="splitbody">
                    <div class="split">
                        <p>Backstory:</p>
                        <textarea id="backstory" class="scrollbar" placeholder="Backstory" readonly></textarea>
                    </div>
                    <div class="split">
                        <p>Extras:</p>
                        <textarea id="extranotes" class="scrollbar" placeholder="Extra notes" readonly></textarea>
                    </div>
                </div>
            </div>

            <div class="page" id="courses" hidden>
                <h2>courses</h2>
            </div>
            <div class="page" id="exams" hidden>
                <h2>exams</h2>
            </div>
            <div class="page" id="relationships" hidden>
                <h2>relationships</h2>
            </div>

            <div class="page" id="jobandextra" hidden>
                <h2>Job</h2>
                <div id="jobs">
                </div>
                <h2>Extracurricular</h2>
                <div id="clubs">
                </div>
            </div>

            <div class="page" id="account" hidden>
                <h2>account</h2>
            </div>
        </div>
    </main>
</body>
</html>

<script src="https://code.jquery.com/jquery-3.6.1.js"></script>
<script src="/javascript/nav.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<script>
    var pageid = 'Loading';
    $(function () {
        var includes = $('[data-include]')
        $.each(includes, function () {
            var file = 'views/addons/_' + $(this).data('include') + '.html'
            $(this).load(file)
        }) 
    })

    $('.choice').click(function () {
        var sidenav = document.getElementById('subnavchoices');
        var choices = sidenav.querySelectorAll('p');
        for (var x = 0; x < choices.length; x++) {
            choices[x].classList = "choice";
        }
        this.classList = "choice selected";

        var mainpage = document.getElementById('pages');
        var pages = mainpage.querySelectorAll('.page');
        for (var x = 0; x < pages.length; x++) {
            if (pages[x]) {
                pages[x].setAttribute("hidden", "true");
            }
        }
        var toshow = this.innerText.toLowerCase();
        if (toshow == "job and extra") {
            toshow = "jobandextra";
        }
        if (toshow == "account details") {
            toshow = "account";
        }
        if (toshow == "logout") {
            logot();
            toshow = "profile";
        }
        document.getElementById(toshow).toggleAttribute("hidden");
    })
    $('.control').click(function () {
        if (this.id == "edit") {
            if (this.classList != "fa fa-pencil-square-o activecontrol") {
                this.classList = "fa fa-pencil-square-o activecontrol";
                togglecurrent();
            } else {
                this.classList = "control fa fa-pencil-square-o";
                togglecurrent();
            }
        }
        if (this.id == "save") {
            var mainpage = document.getElementById('pages');
            var pages = mainpage.querySelectorAll('.page');
            for (var x = 0; x < pages.length; x++) {
                if (pages[x]) {
                    if (window.getComputedStyle(pages[x]).display != "none") {
                        var editbtn = pages[x].querySelector('#edit');
                        if (editbtn.classList != "control fa fa-pencil-square-o") {
                            togglecurrent();
                            editbtn.classList = "control fa fa-pencil-square-o";
                        }
                        var inputs = pages[x].querySelectorAll('input');
                        var textareas = pages[x].querySelectorAll('textarea');
                        var allinputs = [];
                        for (var y = 0; y < inputs.length; y++) {
                            if (inputs[y].id) {
                                allinputs.push(inputs[y]);
                            }
                        }
                        for (var y = 0; y < textareas.length; y++) {
                            if (textareas[y].id) {
                                allinputs.push(textareas[y]);
                            }
                        }
                        saveStudentData(allinputs);
                    }
                }
            }            
        }
    })

    function togglecurrent() {
        var mainpage = document.getElementById('pages');
        var pages = mainpage.querySelectorAll('.page');
        for (var x = 0; x < pages.length; x++) {
            if (pages[x]) {
                if (window.getComputedStyle(pages[x]).display != "none") {
                    var inputs = pages[x].querySelectorAll('input');
                    var textareas = pages[x].querySelectorAll('textarea');
                    for (var y = 0; y < inputs.length; y++) {
                        inputs[y].toggleAttribute("disabled");
                    }
                    for (var y = 0; y < textareas.length; y++) {
                        textareas[y].toggleAttribute("readonly");
                    }
                }
            }
        }
    }
    function toshow(id) {
        var send = 0;
        if (id == "one") {
            send = 0;
        }
        if (id == "two") {
            send = 1;
        }
        if (id == "three") {
            send = 2;
        }
        if (id == "four") {
            send = 3;
        }
        return send;
    }
</script>
<script src="../../API/api.js"></script>
<script src="/javascript/login.js"></script>
<script>
    $(document).ready(function () {
        var data = JSON.parse(sessionStorage.getItem("Student_Id"));
        if (data) {
            getStudentDataByID(data);
        }
    })

    function getStudentDataByID(sid) {
        _supabase.from('_tblStudents').select('*').eq('id', sid).order('id', { ascending: true }).then(response => {
            for (var x = 0; x < response.data.length; x++) {
                var student = response.data[x];  

                var img = student['picture'];
                var name = student['name'];
                var age = student['age'];
                var gender = student['gender'];
                var race = student['race'];
                var subrace = student['subrace'];
                var alignment = student['alignment'];
                var hair = student['haircolour'];
                var eyes = student['eyecolour'];
                var height = student['height'];
                var weight = student['weight'];
                var level = student['level'];
                var cclass = student['class'];
                var subclass = student['subclass'];
                var background = student['background'];
                var personal = student['personalitytraits'];
                var ideal = student['ideals'];
                var bond = student['bonds'];
                var flaw = student['flaws'];
                var goal = student['goals'];
                var bgf = student['backgroundfeatures'];
                var appearance = student['appearance'];

                var story = student['backstory'];
                var notes = student['extranotes'];

                var profile = document.getElementById('profile');
                profile.querySelector('#profilepicture').src = "assets/students/players/" + img;
                profile.querySelector('#name').value = name;
                profile.querySelector('#age').value = age;
                profile.querySelector('#gender').value = gender;
                profile.querySelector('#race').value = race;
                profile.querySelector('#subrace').value = subrace;
                profile.querySelector('#alignment').value = alignment;
                profile.querySelector('#haircolour').value = hair;
                profile.querySelector('#eyecolour').value = eyes;
                profile.querySelector('#height').value = height;
                profile.querySelector('#weight').value = weight;
                profile.querySelector('#level').value = level;
                profile.querySelector('#class').value = cclass;
                profile.querySelector('#subclass').value = subclass;
                profile.querySelector('#background').value = background;
                profile.querySelector('#personalitytraits').value = personal;
                profile.querySelector('#personalitytraits').style.height = profile.querySelector('#personalitytraits').scrollHeight + 'px';
                profile.querySelector('#ideals').value = ideal;
                profile.querySelector('#ideals').style.height = profile.querySelector('#ideals').scrollHeight + 'px';
                profile.querySelector('#bonds').value = bond;
                profile.querySelector('#bonds').style.height = profile.querySelector('#bonds').scrollHeight + 'px';
                profile.querySelector('#flaws').value = flaw;
                profile.querySelector('#flaws').style.height = profile.querySelector('#flaws').scrollHeight + 'px';
                profile.querySelector('#goals').value = goal;
                profile.querySelector('#goals').style.height = profile.querySelector('#goals').scrollHeight + 'px';
                profile.querySelector('#backgroundfeatures').value = bgf;
                profile.querySelector('#backgroundfeatures').style.height = profile.querySelector('#backgroundfeatures').scrollHeight + 'px';
                profile.querySelector('#appearance').value = appearance;
                profile.querySelector('#appearance').style.height = profile.querySelector('#appearance').scrollHeight + 'px';

                var details = document.getElementById('details');
                details.querySelector('#backstory').value = story;
                details.querySelector('#extranotes').value = notes;

                if (name) {
                    var headertitle = document.getElementById('pagename');
                    if (headertitle) {
                        headertitle.innerText = "Welcome " + name;
                    } else {
                        setTimeout(function () {
                            headertitle = document.getElementById('pagename');
                            headertitle.innerText = "Welcome " + name;
                        }, 5000);
                    }
                }
            }
        })
        _supabase.from('Job<>Student').select('Job (id, Title, Location, Pay)').eq('Student', sid).then(response => {
                if (response.data.length > 0) {
                    for (var x = 0; x < response.data.length; x++) {
                        var data = response.data[x];
                        var job = data['Job'];

                        var currentJob = document.getElementById('jobs');

                        const theJob = document.createElement('div');
                        const theTitle = document.createElement('h3');
                        const theLocation = document.createElement('p');
                        const theWage = document.createElement('p');
                        const theCoworker = document.createElement('p');
                        const QuitButton = document.createElement('button');

                        theJob.classList = "job";
                        theJob.id = "job";
                        QuitButton.classList = "quit";
                        QuitButton.id = job['id'];
                        QuitButton.innerText = "Resign";
                        QuitButton.addEventListener('click', quitJob, false);

                        theTitle.innerText = job['Title'];

                        theLocation.innerText = job['Location'];
                        theLocation.classList = "location";

                        theWage.innerText = job['Pay'];
                        theWage.classList = "wage";

                        _supabase.from('Job<>Student').select('Student (id, character_name, character_player)').eq('Job', job['id']).then(response => {
                            var allworkers = response.data;
                            console.log(response.data);
                            var wcount = 0;
                            var coworkers = "";
                            if (allworkers) {
                                for (var y = 0; y < allworkers.length; y++) {
                                    var worker = allworkers[y]['Student'];
                                    if (sessionStorage.getItem('Student_Id') != worker['id']) {
                                        if (wcount > 0) {
                                            coworkers = coworkers + " & " + worker['character_name'];
                                        } else {
                                            coworkers = worker['character_name'];
                                        }
                                        wcount++;
                                    }
                                }
                            }
                            theCoworker.innerText = coworkers;
                            theCoworker.classList = "coworker";

                            theJob.appendChild(theTitle);
                            theJob.appendChild(theLocation);
                            theJob.appendChild(theCoworker);
                            theJob.appendChild(theWage);
                            theJob.appendChild(QuitButton);

                            currentJob.appendChild(theJob);
                        })
                }
            }
        })
        _supabase.from('Club<>Student').select('club (*)').eq('student', sid).then(response => {
            if (response.data.length > 0) {
                var clubs = document.getElementById('clubs');
                for (var x = 0; x < response.data.length; x++) {
                    var data = response.data[x];
                    var club = data['club'];

                    var clubid = club['id'];
                    var clubname = club['name'];
                    var clubskills = club['skills'];

                    const theClub = document.createElement('div');
                    const theClubName = document.createElement('p');
                    const theClubSkill = document.createElement('p');
                    const theClubDice = document.createElement('p');
                    const theClubMembers = document.createElement('div');
                    
                    const theClubQuit = document.createElement('button');

                    theClub.classList = "club";

                    theClubName.classList = "clubname";
                    theClubName.innerText = clubname;

                    theClubSkill.classList = "clubskill";
                    theClubSkill.innerText = clubskills;

                    theClubDice.classList = "dice";
                    theClubDice.innerText = "1d4";

                    theClubMembers.classList = "members";

                    _supabase.from('Club<>Student').select('student (id, name)').eq('club', clubid).then(response => {
                        for (var y = 0; y < response.data.length; y++) {
                            if (sessionStorage.getItem("Student_Id") != response.data[y]['student']['id']) {
                                const theClubMember = document.createElement('p');
                                theClubMember.classList = "member";
                                theClubMember.innerText = response.data[y]['student']['name'];
                                theClubMembers.appendChild(theClubMember);
                            }
                        }
                    })

                    theClubQuit.classList = "quit";
                    theClubQuit.innerText = "Quit Club";
                    theClubQuit.id = clubid;
                    theClubQuit.addEventListener('click', quitClub, false);

                    theClub.appendChild(theClubName);
                    theClub.appendChild(theClubSkill);
                    theClub.appendChild(theClubDice);
                    theClub.appendChild(theClubMembers);

                    theClub.appendChild(theClubQuit);

                    clubs.appendChild(theClub);
                }
            }
        })
    }
    function saveStudentData(inputs) {
        var updateobject = {};
        for (var x = 0; x < inputs.length; x++) {
            updateobject[inputs[x].id] = inputs[x].value;
        }
        _supabase.from('_tblStudents').update( updateobject ).eq('id', sessionStorage.getItem("Student_Id")).then(response => {
            var currentpage = location.pathname;
            window.location = currentpage;
        })
    }

    function quitJob() {
        var sid = JSON.parse(sessionStorage.getItem("Student_Id"));
        _supabase.from('Job<>Student').delete().eq('Student', sid).then(response => {
        })
        alert("You have now resigned");
        document.getElementById('myjob').style.display = "none";
    }
    function quitClub() {
        var sid = JSON.parse(sessionStorage.getItem("Student_Id"));
        var cid = this.id;
        _supabase.from('Club<>Student').delete().eq('club', cid).eq('student', sid).then(response => {
            alert("you have left the club");
            var parent = this.parentNode;
            parent.style.display = "none";
        })        
    }

var x;
var $cards = $(".card");
var $style = $(".hover");

$cards
  .on("mousemove touchmove", function(e) { 
    // normalise touch/mouse
    e.preventDefault();
    var $card = $(this);
    var h = $card.height();
    var w = $card.width();
    var px = Math.abs(Math.floor(100 / w * 0)-100);
    var py = Math.abs(Math.floor(100 / h * 0)-100);
    var pa = (50-px)+(50-py);
    // set / apply css class and style
    $cards.removeClass("active");
    $card.removeClass("animated");
    if ( e.type === "touchmove" ) {
      return false; 
    }
    clearTimeout(x);
  }).on("mouseout touchend touchcancel", function() {
    // remove css, apply custom animation on end
    var $card = $(this);
    $style.html("");
    x = setTimeout(function() {
      $card.addClass("animated");
    },1000);
  });
</script>